<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>á»¨ng dá»¥ng AI Báº¡n cá»§a nhÃ  nÃ´ng</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#f1f8e9,#c8e6c9);padding:14px;text-align:center}
  h1{color:#1b5e20;margin:6px 0 10px;font-size:22px}
  video,img{width:94%;max-width:420px;border-radius:12px;border:3px solid #4caf50;margin:8px auto;display:block}
  button{display:block;margin:8px auto;padding:12px 18px;font-size:18px;border-radius:10px;border:none;background:#43a047;color:#fff;cursor:pointer;width:90%;max-width:420px}
  button.secondary{background:#fff;color:#2e7d32;border:2px solid #4caf50}
  button:disabled{background:#ccc;color:#666;cursor:not-allowed}
  #result{margin-top:12px;font-size:18px;font-weight:700;color:#1b5e20}
  #details{display:none;background:#fff;margin:14px auto;padding:12px;border-radius:10px;max-width:420px;text-align:left;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  #details h3{color:#2e7d32;margin-bottom:8px;text-align:center}
  #details p{margin:6px 0;font-size:16px;color:#2e2e2e}
</style>
</head>
<body>
  <h1>ğŸŒ¾ á»¨ng dá»¥ng AI Báº¡n cá»§a nhÃ  nÃ´ng</h1>

  <video id="webcam" autoplay playsinline muted></video>
  <img id="preview" style="display:none">

  <button id="startBtn">ğŸ“· Báº­t camera</button>
  <button id="switchBtn" class="secondary" disabled>ğŸ”„ Äá»•i camera</button>
  <button id="captureBtn" disabled>ğŸ–¼ï¸ Chá»¥p áº£nh</button>
  <button id="analyzeBtn" disabled>ğŸ¤– PhÃ¢n tÃ­ch bá»‡nh</button>
  <button id="detailsBtn" disabled>ğŸ“– Xem chi tiáº¿t</button>
  <button id="speakBtn" disabled>ğŸ”Š Nghe láº¡i thÃ´ng tin bá»‡nh</button>

  <div id="result">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>

  <div id="details">
    <h3>ğŸ“˜ ThÃ´ng tin chi tiáº¿t</h3>
    <p><b>Biá»ƒu hiá»‡n:</b> <span id="symptoms"></span></p>
    <p><b>NguyÃªn nhÃ¢n:</b> <span id="causes"></span></p>
    <p><b>PhÃ²ng ngá»«a:</b> <span id="prevention"></span></p>
    <p><b>ChÄƒm sÃ³c:</b> <span id="care"></span></p>
    <p><b>Äiá»u trá»‹:</b> <span id="treatment"></span></p>
  </div>

<script>
/* ====== Cáº¥u hÃ¬nh ====== */
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
let model=null, stream=null, devices=[], currentDeviceId=null, lastClassName=null, ttsUnlocked=false;

/* ====== Map + dá»¯ liá»‡u bá»‡nh (giá»¯ ngáº¯n gá»n) ====== */
const nameMap = {
  "BENH_KHO_VAN":"Bá»‡nh khÃ´ váº±n",
  "BENH_DOM_LA_LON":"Bá»‡nh Ä‘á»‘m lÃ¡ lá»›n",
  "BENH_PHAN_DEN":"Bá»‡nh pháº¥n Ä‘en",
  "CAY_NGO_KHOE":"CÃ¢y ngÃ´ khá»e"
};
const diseaseDetails = {
  "Bá»‡nh khÃ´ váº±n": {
    symptoms: "Váº¿t loang xÃ¡m tro trÃªn báº¹ lÃ¡ vÃ  thÃ¢n; lan tá»« gá»‘c lÃªn báº¯p, lÃ m lÃ¡ vÃ ng khÃ´.",
    causes: "Náº¥m Rhizoctonia solani; áº©m Ä‘á»™ cao, 25â€“30Â°C.",
    prevention: "Chá»n giá»‘ng Ã­t nhiá»…m, vá»‡ sinh Ä‘á»“ng ruá»™ng, luÃ¢n canh.",
    care: "Giá»¯ ruá»™ng thÃ´ng thoÃ¡ng, háº¡n cháº¿ Ä‘áº¡m.",
    treatment: "Phun thuá»‘c khuyáº¿n cÃ¡o (Anvil, Tilt...)."
  },
  "Bá»‡nh Ä‘á»‘m lÃ¡ lá»›n": {
    symptoms: "Äá»‘m báº§u dá»¥c dÃ i, giá»¯a xÃ¡m tro; náº·ng lÃ m lÃ¡ khÃ´.",
    causes: "Náº¥m Exserohilum turcicum; khÃ­ háº­u nÃ³ng áº©m.",
    prevention: "LuÃ¢n canh, dá»n tÃ n dÆ°, giá»‘ng khÃ¡ng.",
    care: "Giáº£m Ä‘áº¡m, tÄƒng kali, cháº¿ pháº©m sinh há»c.",
    treatment: "Phun Daconil/Score/Tilt."
  },
  "Bá»‡nh pháº¥n Ä‘en": {
    symptoms: "U sÆ°ng tráº¯ng trÃªn báº¹/trÃ¡i, bÃªn trong lÃ  bá»™t Ä‘en (bÃ o tá»­).",
    causes: "Náº¥m Ustilago; lÃ¢y qua giÃ³/nÆ°á»›c/váº¿t thÆ°Æ¡ng.",
    prevention: "Xá»­ lÃ½ háº¡t giá»‘ng, luÃ¢n canh, dá»n tÃ n dÆ°.",
    care: "Cáº¯t bá» pháº§n bá»‡nh, tÄƒng kali vÃ  há»¯u cÆ¡.",
    treatment: "Phun thuá»‘c chá»©a tebuconazole, propiconazole..."
  },
  "CÃ¢y ngÃ´ khá»e": {
    symptoms: "LÃ¡ xanh bÃ³ng, khÃ´ng váº¿t bá»‡nh.",
    causes: "Äiá»u kiá»‡n sinh trÆ°á»Ÿng tá»‘t.",
    prevention: "Duy trÃ¬ tÆ°á»›i bÃ³n cÃ¢n báº±ng.",
    care: "Giá»¯ thÃ´ng thoÃ¡ng, phÃ²ng bá»‡nh Ä‘á»‹nh ká»³.",
    treatment: "KhÃ´ng cáº§n xá»­ lÃ½."
  }
};

/* ====== Elements ====== */
const videoEl = document.getElementById('webcam');
const previewEl = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const detailsBtn = document.getElementById('detailsBtn');
const speakBtn = document.getElementById('speakBtn');
const resultDiv = document.getElementById('result');
const detailsDiv = document.getElementById('details');
const symptomsEl = document.getElementById('symptoms');
const causesEl = document.getElementById('causes');
const preventionEl = document.getElementById('prevention');
const careEl = document.getElementById('care');
const treatmentEl = document.getElementById('treatment');

/* ====== TTS helper & unlock ====== */
function speak(text) {
  try {
    if (!('speechSynthesis' in window)) return;
    // if not unlocked, attempt to unlock in user gesture
    if (!ttsUnlocked) {
      ttsUnlocked = true;
      const u0 = new SpeechSynthesisUtterance('á»¨ng dá»¥ng sáºµn sÃ ng Ä‘á»c báº±ng tiáº¿ng Viá»‡t.');
      u0.lang = 'vi-VN';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u0);
      setTimeout(() => {
        const u1 = new SpeechSynthesisUtterance(text);
        u1.lang = 'vi-VN';
        u1.rate = 0.95;
        window.speechSynthesis.speak(u1);
      }, 350);
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'vi-VN';
    u.rate = 0.95;
    window.speechSynthesis.speak(u);
  } catch (e) { console.warn('TTS error', e); }
}

/* ====== Normalize & fuzzy find ====== */
function normalizeLabel(s){
  if(!s) return '';
  return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9\s_-]/g,'').trim().toUpperCase().replace(/\s+/g,'_');
}
function findClosestName(label){
  if(!label) return null;
  const n = normalizeLabel(label);
  // check nameMap keys
  for(const k in nameMap) if(n === k || n.includes(k) || k.includes(n)) return nameMap[k];
  // check diseaseDetails keys
  for(const k in diseaseDetails) {
    if(normalizeLabel(k) === n || normalizeLabel(k).includes(n) || n.includes(normalizeLabel(k))) return k;
  }
  return null;
}

/* ====== Load model ====== */
async function loadModel(){
  resultDiv.innerText = 'â³ Äang táº£i mÃ´ hÃ¬nh...';
  await tf.ready();
  model = await tmImage.load(MODEL_URL+'model.json', MODEL_URL+'metadata.json');
  resultDiv.innerText = 'âœ… MÃ´ hÃ¬nh sáºµn sÃ ng. Nháº¥n Báº­t camera.';
}
loadModel();

/* ====== Devices & camera ====== */
async function enumDevices(){
  try {
    const all = await navigator.mediaDevices.enumerateDevices();
    devices = all.filter(d => d.kind === 'videoinput');
    switchBtn.disabled = devices.length < 2;
  } catch(e) { devices = []; switchBtn.disabled = true; }
}

async function startCamera(preferBack=true){
  try {
    await enumDevices();
    let constraints = { video: { facingMode: { ideal: 'environment' } } };
    const back = devices.find(d => /back|rear|environment/i.test(d.label));
    if(preferBack && back) constraints = { video: { deviceId: { exact: back.deviceId } } };
    if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream;
    await new Promise(r => {
      const check = () => { if(videoEl.videoWidth && videoEl.videoHeight) r(); else requestAnimationFrame(check); };
      check();
    });
    captureBtn.disabled = false;
    analyzeBtn.disabled = true;
    detailsBtn.disabled = true;
    speakBtn.disabled = true;
    startBtn.disabled = true;
    resultDiv.innerText = 'ğŸ“¸ Camera Ä‘Ã£ báº­t. HÃ£y chá»¥p áº£nh.';
    speak('Camera Ä‘Ã£ báº­t. HÃ£y chá»¥p áº£nh.');
    await enumDevices();
  } catch(e) {
    console.error(e);
    alert('KhÃ´ng thá»ƒ báº­t camera. Má»Ÿ Chrome vÃ  cáº¥p quyá»n camera.');
    resultDiv.innerText = 'âŒ KhÃ´ng thá»ƒ báº­t camera';
  }
}
async function switchCamera(){
  if(devices.length < 2) return;
  const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
  const next = devices[(idx + 1) % devices.length] || devices[0];
  currentDeviceId = next.deviceId;
  await startCamera(false);
}

/* ====== Capture ====== */
async function captureImage(){
  if(!stream){ alert('ChÆ°a báº­t camera.'); return; }
  if(!videoEl.videoWidth || !videoEl.videoHeight){
    await new Promise(res => {
      const check = () => { if(videoEl.videoWidth && videoEl.videoHeight) res(); else requestAnimationFrame(check); };
      check();
    });
  }
  const c = document.createElement('canvas');
  c.width = videoEl.videoWidth; c.height = videoEl.videoHeight;
  c.getContext('2d').drawImage(videoEl,0,0,c.width,c.height);
  previewEl.src = c.toDataURL('image/jpeg', 0.92);
  previewEl.style.display = 'block';
  analyzeBtn.disabled = false;
  detailsBtn.disabled = true;
  speakBtn.disabled = true;
  resultDiv.innerText = 'ğŸ–¼ï¸ áº¢nh Ä‘Ã£ chá»¥p.';
  speak('áº¢nh Ä‘Ã£ chá»¥p. Nháº¥n phÃ¢n tÃ­ch.');
}

/* ====== Analyze ====== */
async function analyzeImage(){
  if(!model){ alert('MÃ´ hÃ¬nh chÆ°a sáºµn sÃ ng.'); return; }
  if(!previewEl.src){ alert('Báº¡n cáº§n chá»¥p áº£nh trÆ°á»›c.'); return; }
  resultDiv.innerText = 'ğŸ” Äang phÃ¢n tÃ­ch...';
  await new Promise(r => previewEl.complete ? r() : previewEl.onload = r);
  try {
    const preds = await model.predict(previewEl);
    preds.sort((a,b)=>b.probability-a.probability);
    const top = preds[0];
    const raw = String(top.className || '');
    const name = findClosestName(raw) || raw.trim() || 'KhÃ´ng xÃ¡c Ä‘á»‹nh';
    const conf = (top.probability*100).toFixed(1);
    resultDiv.innerText = `Káº¿t luáº­n: ${name} (${conf}%)`;
    speak(`Káº¿t luáº­n: ${name}. Äá»™ tin cáº­y ${conf} pháº§n trÄƒm.`);
    lastClassName = name;
    showDetails(name);
    detailsBtn.disabled = false;
    speakBtn.disabled = false;
  } catch(e){
    console.error(e);
    resultDiv.innerText = 'âŒ Lá»—i khi phÃ¢n tÃ­ch';
    speak('Lá»—i khi phÃ¢n tÃ­ch. Vui lÃ²ng thá»­ láº¡i.');
  }
}

/* ====== Show details & speak details ====== */
function showDetails(name){
  let info = diseaseDetails[name];
  if(!info){
    const fb = findClosestName(name);
    if(fb) info = diseaseDetails[fb];
  }
  if(!info){
    symptomsEl.textContent=''; causesEl.textContent=''; preventionEl.textContent=''; careEl.textContent=''; treatmentEl.textContent='';
    return false;
  }
  symptomsEl.textContent = info.symptoms;
  causesEl.textContent = info.causes;
  preventionEl.textContent = info.prevention;
  careEl.textContent = info.care;
  treatmentEl.textContent = info.treatment;
  return true;
}

detailsBtn.addEventListener('click', ()=>{
  if(!lastClassName){ alert('Báº¡n chÆ°a phÃ¢n tÃ­ch áº£nh.'); return; }
  const ok = showDetails(lastClassName);
  if(!ok){ alert('ChÆ°a cÃ³ thÃ´ng tin chi tiáº¿t cho káº¿t quáº£ nÃ y.'); return; }
  detailsDiv.style.display = detailsDiv.style.display === 'block' ? 'none' : 'block';
  if(detailsDiv.style.display === 'block'){
    const d = diseaseDetails[lastClassName] || diseaseDetails[findClosestName(lastClassName)];
    if(d) speak(`Biá»ƒu hiá»‡n: ${d.symptoms}. NguyÃªn nhÃ¢n: ${d.causes}. PhÃ²ng ngá»«a: ${d.prevention}. ChÄƒm sÃ³c: ${d.care}. Äiá»u trá»‹: ${d.treatment}.`);
  }
});

speakBtn.addEventListener('click', ()=>{
  if(!lastClassName){ alert('ChÆ°a cÃ³ káº¿t quáº£ phÃ¢n tÃ­ch.'); return; }
  const d = diseaseDetails[lastClassName] || diseaseDetails[findClosestName(lastClassName)];
  if(!d){ alert('KhÃ´ng cÃ³ thÃ´ng tin chi tiáº¿t.'); return; }
  speak(`Biá»ƒu hiá»‡n: ${d.symptoms}. NguyÃªn nhÃ¢n: ${d.causes}. PhÃ²ng ngá»«a: ${d.prevention}. ChÄƒm sÃ³c: ${d.care}. Äiá»u trá»‹: ${d.treatment}.`);
});

/* ====== Events ====== */
startBtn.addEventListener('click', ()=>startCamera());
switchBtn.addEventListener('click', ()=>switchCamera());
captureBtn.addEventListener('click', ()=>captureImage());
analyzeBtn.addEventListener('click', ()=>analyzeImage());

/* ====== Init ====== */
(function init(){
  captureBtn.disabled=true; analyzeBtn.disabled=true; detailsBtn.disabled=true; speakBtn.disabled=true;
  enumDevices();
})();
</script>
</body>
</html>
