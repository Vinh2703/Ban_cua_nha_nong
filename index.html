<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ứng dụng AI Bạn của nhà nông</title>

  <!-- TensorFlow & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; background: linear-gradient(135deg,#f1f8e9,#c8e6c9); text-align:center; padding:14px; }
    h1 { color:#1b5e20; margin:6px 0 10px; font-size:22px; }
    video, img { width:94%; max-width:420px; border-radius:12px; border:3px solid #4caf50; margin:8px auto; display:block; }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:6px; }
    button { display:block; margin:8px auto; padding:12px 18px; font-size:18px; border-radius:10px; border:none; background:#43a047; color:#fff; cursor:pointer; width:90%; max-width:420px; }
    button.secondary { background:#fff; color:#2e7d32; border:2px solid #4caf50; }
    button:disabled { background:#ccc; color:#666; cursor:not-allowed; }
    #result { margin-top:12px; font-size:18px; font-weight:700; color:#1b5e20; }
    #details { display:none; background:#fff; margin:14px auto; padding:12px; border-radius:10px; max-width:420px; text-align:left; box-shadow:0 2px 8px rgba(0,0,0,0.12); }
    #details h3 { color:#2e7d32; margin-bottom:8px; text-align:center; }
    #details p { margin:6px 0; font-size:16px; color:#2e2e2e; }
    .small { font-size:13px; color:#4b6b4b; margin-top:6px; }
  </style>
</head>
<body>
  <h1>🌾 Ứng dụng AI Bạn của nhà nông</h1>

  <!-- muted + playsinline giúp mobile play nhanh hơn -->
  <video id="webcam" autoplay playsinline muted></video>
  <img id="preview" style="display:none">

  <div class="row">
    <button id="startBtn">📷 Bật camera</button>
    <button id="switchBtn" class="secondary" disabled>🔄 Đổi camera</button>
  </div>

  <div class="row">
    <button id="captureBtn" disabled>🖼️ Chụp ảnh</button>
    <button id="analyzeBtn" disabled>🤖 Phân tích bệnh</button>
  </div>

  <div class="row">
    <button id="detailsBtn" disabled>📖 Xem chi tiết</button>
    <button id="speakBtn" disabled>🔊 Nghe lại thông tin bệnh</button>
  </div>

  <div id="result">Chưa có dữ liệu.</div>

  <div id="details">
    <h3>📘 Thông tin chi tiết</h3>
    <p><b>Biểu hiện:</b> <span id="symptoms"></span></p>
    <p><b>Nguyên nhân:</b> <span id="causes"></span></p>
    <p><b>Phòng ngừa:</b> <span id="prevention"></span></p>
    <p><b>Chăm sóc:</b> <span id="care"></span></p>
    <p><b>Điều trị:</b> <span id="treatment"></span></p>
  </div>

<script>
/* --------- CONFIG ---------- */
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
let model = null;
let stream = null;
let devices = [];
let currentDeviceId = null;
let lastClassName = null; // => Vietnamese display name (key to diseaseDetails)
let ttsUnlocked = false;  // whether TTS has been unlocked by a user gesture

/* --------- MAPPING & DATA (replace/extend as needed) ---------- */
const nameMap = {
  "BENH_KHO_VAN": "Bệnh khô vằn",
  "BENH_DOM_LA_LON": "Bệnh đốm lá lớn",
  "BENH_PHAN_DEN": "Bệnh phấn đen",
  "CAY_NGO_KHOE": "Cây ngô khỏe"
};

const diseaseDetails = {
  "Bệnh khô vằn": {
    symptoms: "Vết loang xám tro trên bẹ lá và thân, hình dạng bất định. Bệnh lan từ gốc lên bắp làm lá vàng khô và cây chết dần.",
    causes: "Do nấm Rhizoctonia solani Kuhn, phát triển mạnh trong điều kiện ẩm cao, nhiệt độ 25–30°C.",
    prevention: "Chọn giống ít nhiễm, gieo đúng thời vụ, vệ sinh đồng ruộng, tiêu hủy tàn dư cây bệnh.",
    care: "Giữ ruộng thông thoáng, không bón thừa đạm, dùng chế phẩm Trichoderma.",
    treatment: "Phun thuốc Anvil, Azotide, Tilt Super hoặc Evitin theo hướng dẫn."
  },
  "Bệnh đốm lá lớn": {
    symptoms: "Trên lá xuất hiện đốm bầu dục hoặc thoi, nâu nhạt đến nâu đậm, giữa đốm xám tro. Khi ẩm ướt, bệnh lan nhanh làm lá khô cháy.",
    causes: "Do nấm Exserohilum turcicum, phát triển mạnh khi thời tiết nóng ẩm.",
    prevention: "Luân canh cây trồng, dọn sạch tàn dư, bón phân cân đối.",
    care: "Giảm đạm, tăng kali, phun chế phẩm sinh học phòng bệnh.",
    treatment: "Phun Daconil, Score hoặc Tilt khi bệnh lan rộng."
  },
  "Bệnh phấn đen": {
    symptoms: "Xuất hiện u sưng trắng trên bẹ lá, thân, bắp. Bên trong chứa bột đen là bào tử nấm.",
    causes: "Do nấm Ustilago maydis hoặc Ustilago zeae gây ra, phát tán qua gió, nước, vết thương.",
    prevention: "Luân canh cây trồng, xử lý hạt giống, dọn sạch tàn dư cây bệnh.",
    care: "Cắt bỏ phần bị bệnh, tăng cường bón kali và hữu cơ.",
    treatment: "Phun Antafungal hoặc thuốc chứa tebuconazole, propiconazole, hexaconazole."
  },
  "Cây ngô khỏe": {
    symptoms: "Lá xanh bóng, không có đốm bệnh hay phấn phủ.",
    causes: "Cây phát triển trong điều kiện sinh trưởng tốt.",
    prevention: "Duy trì tưới tiêu hợp lý, bón phân cân đối.",
    care: "Giữ ruộng thông thoáng, tránh ngập úng.",
    treatment: "Không cần xử lý thêm."
  }
};

/* --------- Elements -------- */
const videoEl = document.getElementById('webcam');
const previewEl = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const detailsBtn = document.getElementById('detailsBtn');
const speakBtn = document.getElementById('speakBtn');
const resultDiv = document.getElementById('result');
const detailsBox = document.getElementById('details');
const symptomsEl = document.getElementById('symptoms');
const causesEl = document.getElementById('causes');
const preventionEl = document.getElementById('prevention');
const careEl = document.getElementById('care');
const treatmentEl = document.getElementById('treatment');

/* --------- TTS helper & unlock on user gesture -------- */
function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    // if not unlocked yet, try to unlock with a short phrase (must be in user gesture)
    if(!ttsUnlocked){
      // do a short phrase to unlock — this should be called inside a user click handler
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('Ứng dụng đã sẵn sàng để đọc.');
      u.lang = 'vi-VN';
      u.rate = 0.95;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
      ttsUnlocked = true;
      // continue to speak the desired text slightly delayed
      setTimeout(() => {
        const u2 = new SpeechSynthesisUtterance(text);
        u2.lang = 'vi-VN';
        u2.rate = 0.95;
        u2.pitch = 1.0;
        window.speechSynthesis.speak(u2);
      }, 350);
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'vi-VN';
    u.rate = 0.95;
    u.pitch = 1.0;
    window.speechSynthesis.speak(u);
  }catch(e){
    console.warn('TTS error', e);
  }
}

/* --------- Load model (async) -------- */
async function loadModel(){
  resultDiv.innerText = '⏳ Đang tải mô hình...';
  try{
    await tf.ready();
    model = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
    resultDiv.innerText = '✅ Mô hình sẵn sàng. Nhấn "Bật camera" để bắt đầu.';
    console.log('Model loaded');
    // enumerate devices early so we can enable switch if >1
    await enumerateVideoDevices();
  }catch(err){
    console.error('Load model err', err);
    resultDiv.innerText = '❌ Lỗi tải mô hình';
  }
}
loadModel();

/* --------- Devices & camera functions -------- */
async function enumerateVideoDevices(){
  try{
    const all = await navigator.mediaDevices.enumerateDevices();
    devices = all.filter(d => d.kind === 'videoinput');
    switchBtn.disabled = devices.length < 2;
  }catch(e){
    console.warn('enumerateDevices', e);
    devices = [];
    switchBtn.disabled = true;
  }
}

async function startCamera(preferBack = true){
  try{
    // user gesture: try to unlock TTS here by speaking once (short)
    if(!ttsUnlocked){
      ttsUnlocked = true;
      // small silent utterance may be blocked, so speak short message
      window.speechSynthesis.cancel();
      const u0 = new SpeechSynthesisUtterance(''); // some browsers accept empty; safe fallback below
      u0.lang = 'vi-VN';
      try { window.speechSynthesis.speak(u0); } catch(e){ /*ignore*/ }
    }

    await enumerateVideoDevices();
    let constraints;
    if(devices.length > 0){
      const back = devices.find(d => /back|rear|environment/i.test(d.label));
      if(preferBack && back){
        currentDeviceId = back.deviceId;
        constraints = { video: { deviceId: { exact: currentDeviceId } } };
      } else {
        // fallback to facingMode
        constraints = { video: { facingMode: { ideal: 'environment' } } };
      }
    } else {
      constraints = { video: true };
    }

    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream;

    // wait until metadata loaded and video has dimensions
    await new Promise(resolve => {
      const onLoaded = () => {
        const check = () => {
          if(videoEl.videoWidth && videoEl.videoHeight) resolve();
          else requestAnimationFrame(check);
        };
        check();
      };
      videoEl.onloadedmetadata = onLoaded;
      setTimeout(resolve, 2000); // fallback
    });

    captureBtn.disabled = false;
    analyzeBtn.disabled = true;
    detailsBtn.disabled = true;
    speakBtn.disabled = true;
    startBtn.disabled = true;

    resultDiv.innerText = '📸 Camera đã bật. Hướng lá ngô vào khung hình và chụp ảnh.';
    speak('Camera đã bật. Hướng lá ngô vào khung hình và chụp ảnh.');

    await enumerateVideoDevices(); // refresh labels
    switchBtn.disabled = devices.length < 2;
  }catch(err){
    console.error('startCamera err', err);
    alert('⚠️ Không thể bật camera. Hãy mở bằng Chrome và cấp quyền camera.');
    resultDiv.innerText = '❌ Không thể bật camera';
  }
}

async function switchCamera(){
  if(devices.length < 2) return;
  const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
  const next = devices[(idx + 1) % devices.length] || devices[0];
  currentDeviceId = next.deviceId;
  await startCamera(false);
}

/* --------- Capture image: wait for video readiness -------- */
async function captureImage(){
  if(!stream){
    alert('Chưa bật camera. Nhấn Bật camera trước khi chụp.');
    return;
  }
  // wait until video has size
  if(!videoEl.videoWidth || !videoEl.videoHeight){
    await new Promise(res => {
      const check = () => {
        if(videoEl.videoWidth && videoEl.videoHeight) res();
        else requestAnimationFrame(check);
      };
      check();
    });
  }

  const canvas = document.createElement('canvas');
  canvas.width = videoEl.videoWidth;
  canvas.height = videoEl.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
  previewEl.src = canvas.toDataURL('image/jpeg', 0.92);
  previewEl.style.display = 'block';

  analyzeBtn.disabled = false;
  detailsBtn.disabled = true;
  speakBtn.disabled = true;
  resultDiv.innerText = '🖼️ Ảnh đã chụp. Nhấn Phân tích để xem kết quả.';
  speak('Ảnh đã chụp. Nhấn phân tích để xem kết quả.');
}

/* --------- Normalize label helper -------- */
function normalizeLabel(label){
  if(!label) return '';
  // to uppercase, trim, decompose and remove diacritics, replace spaces with underscore
  const noDiacrit = label.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return noDiacrit.trim().toUpperCase().replace(/\s+/g, '_').replace(/[^A-Z0-9_]/g,'');
}

/* --------- Analyze image -------- */
async function analyzeImage(){
  if(!model){
    alert('Mô hình chưa sẵn sàng. Vui lòng đợi.');
    return;
  }
  if(!previewEl.src){
    alert('Bạn cần chụp ảnh trước khi phân tích.');
    return;
  }
  resultDiv.innerText = '🔍 Đang phân tích...';
  try{
    await new Promise(res => previewEl.complete ? res() : previewEl.onload = res);
    const predictions = await model.predict(previewEl);
    if(!Array.isArray(predictions) || predictions.length === 0) throw new Error('No predictions');
    predictions.sort((a,b) => b.probability - a.probability);
    const top = predictions[0];
    const raw = String(top.className || '');
    const norm = normalizeLabel(raw); // e.g., BENH_PHAN_DEN
    // try mapping by several variants
    let name = nameMap[norm] || nameMap[raw.toUpperCase()] || nameMap[raw] || null;
    // if still null, try human-friendly fallback: capitalize raw
    if(!name){
      name = raw.trim();
    }
    const conf = (top.probability * 100).toFixed(1);
    resultDiv.innerText = `Kết luận: ${name} (${conf}%)`;
    // Attempt to speak - unlock if needed (user gesture already occurred earlier)
    speak(`Kết luận: ${name}. Độ tin cậy ${conf} phần trăm.`);
    lastClassName = name;
    // prepare details content
    showDetails(name); // populate content (may be empty if not found)
    // enable buttons only when we have something meaningful
    detailsBtn.disabled = false;
    speakBtn.disabled = false;
    analyzeBtn.disabled = false;
  }catch(err){
    console.error('analyze err', err);
    resultDiv.innerText = '❌ Lỗi khi phân tích';
    speak('Lỗi khi phân tích ảnh. Vui lòng thử lại.');
  }
}

/* --------- Fill detail fields (but don't auto-show) -------- */
function showDetails(name){
  const info = diseaseDetails[name];
  if(!info){
    // clear fields if no info
    symptomsEl.textContent = '';
    causesEl.textContent = '';
    preventionEl.textContent = '';
    careEl.textContent = '';
    treatmentEl.textContent = '';
    return false;
  }
  symptomsEl.textContent = info.symptoms;
  causesEl.textContent = info.causes;
  preventionEl.textContent = info.prevention;
  careEl.textContent = info.care;
  treatmentEl.textContent = info.treatment;
  return true;
}

/* --------- Details button: toggle content and read when shown -------- */
detailsBtn.addEventListener('click', () => {
  if(!lastClassName){
    alert('Bạn chưa phân tích ảnh. Vui lòng phân tích trước.');
    return;
  }
  // ensure content is ready
  const ok = showDetails(lastClassName);
  if(!ok){
    alert('Chưa có thông tin chi tiết cho kết quả này.');
    return;
  }
  if(detailsBox.style.display === 'block'){
    detailsBox.style.display = 'none';
  } else {
    detailsBox.style.display = 'block';
    // speak details (also ensures TTS flow)
    const d = diseaseDetails[lastClassName];
    if(d) speak(`Biểu hiện: ${d.symptoms}. Nguyên nhân: ${d.causes}. Phòng ngừa: ${d.prevention}. Chăm sóc: ${d.care}. Điều trị: ${d.treatment}.`);
  }
});

/* --------- Speak button: read details again -------- */
speakBtn.addEventListener('click', () => {
  if(!lastClassName){
    alert('Chưa có kết quả phân tích. Vui lòng phân tích trước.');
    return;
  }
  const d = diseaseDetails[lastClassName];
  if(!d){
    alert('Không có thông tin chi tiết cho kết quả này.');
    return;
  }
  speak(`Biểu hiện: ${d.symptoms}. Nguyên nhân: ${d.causes}. Phòng ngừa: ${d.prevention}. Chăm sóc: ${d.care}. Điều trị: ${d.treatment}.`);
});

/* --------- Wire up buttons -------- */
startBtn.addEventListener('click', () => {
  // start camera is a user gesture — good moment to unlock TTS
  startCamera();
});
switchBtn.addEventListener('click', () => switchCamera());
captureBtn.addEventListener('click', () => captureImage());
analyzeBtn.addEventListener('click', () => analyzeImage());

/* --------- initial UI state -------- */
(function init(){
  captureBtn.disabled = true;
  analyzeBtn.disabled = true;
  detailsBtn.disabled = true;
  speakBtn.disabled = true;
  switchBtn.disabled = true;
})();
</script>
</body>
</html>
