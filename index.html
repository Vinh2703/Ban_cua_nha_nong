<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Nháº­n diá»‡n bá»‡nh trÃªn lÃ¡</title>

  <!-- TensorFlow.js vÃ  Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      text-align: center;
      padding: 10px;
    }
    h1 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    video, img {
      width: 90%;
      max-width: 360px;
      border-radius: 10px;
      border: 2px solid #81c784;
      margin-top: 10px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #66bb6a;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #1b5e20;
    }
    #details {
      background: #f1f8e9;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      display: none;
      text-align: left;
    }
    #details p { margin: 5px 0; }
  </style>
</head>

<body>
  <h1>ğŸŒ¿ AI Nháº­n diá»‡n bá»‡nh trÃªn lÃ¡</h1>

  <!-- Hiá»ƒn thá»‹ camera vÃ  áº£nh chá»¥p -->
  <video id="webcam" autoplay playsinline></video>
  <img id="preview" style="display:none;">

  <!-- CÃ¡c nÃºt Ä‘iá»u khiá»ƒn -->
  <div>
    <button id="startBtn">ğŸ“· Báº­t camera</button>
    <button id="switchBtn" disabled>ğŸ”„ Äá»•i camera</button>
    <button id="stopBtn" disabled>ğŸ›‘ Táº¯t camera</button>
    <button id="captureBtn" disabled>ğŸ“¸ Chá»¥p áº£nh</button>
    <button id="analyzeBtn" disabled>ğŸ¤– PhÃ¢n tÃ­ch</button>
    <button id="detailsBtn" disabled>ğŸ“– Xem chi tiáº¿t</button>
  </div>

  <!-- Káº¿t quáº£ -->
  <div id="result">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>

  <!-- ThÃ´ng tin chi tiáº¿t bá»‡nh -->
  <div id="details">
    <h3>Chi tiáº¿t bá»‡nh:</h3>
    <p><b>Triá»‡u chá»©ng:</b> <span id="symptoms"></span></p>
    <p><b>NguyÃªn nhÃ¢n:</b> <span id="causes"></span></p>
    <p><b>PhÃ²ng ngá»«a:</b> <span id="prevention"></span></p>
    <p><b>ChÄƒm sÃ³c:</b> <span id="care"></span></p>
    <p><b>Äiá»u trá»‹:</b> <span id="treatment"></span></p>
  </div>

  <script>
  const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
  let model = null, stream = null, currentDeviceId = null, videoDevices = [];

  const diseaseDetails = {
    "Bá»†NH Äá»M NÃ‚U": {
      symptoms: "Xuáº¥t hiá»‡n cÃ¡c Ä‘á»‘m nÃ¢u trÃ²n, sau lan rá»™ng lÃ m khÃ´ lÃ¡.",
      causes: "Náº¥m Cercospora sp phÃ¡t triá»ƒn trong Ä‘iá»u kiá»‡n áº©m Æ°á»›t.",
      prevention: "KhÃ´ng tÆ°á»›i quÃ¡ áº©m, tá»‰a thÆ°a lÃ¡, luÃ¢n canh cÃ¢y trá»“ng.",
      care: "Giá»¯ vÆ°á»n thÃ´ng thoÃ¡ng, loáº¡i bá» lÃ¡ bá»‡nh.",
      treatment: "Phun thuá»‘c gá»‘c Ä‘á»“ng hoáº·c Mancozeb theo hÆ°á»›ng dáº«n."
    },
    "Bá»†NH KHÃ” LÃ": {
      symptoms: "LÃ¡ khÃ´ tá»« mÃ©p vÃ o, chuyá»ƒn vÃ ng, dá»… rá»¥ng.",
      causes: "Do náº¥m Alternaria sp gÃ¢y ra.",
      prevention: "TrÃ¡nh tÆ°á»›i nÆ°á»›c lÃªn lÃ¡, kiá»ƒm soÃ¡t Ä‘á»™ áº©m.",
      care: "Thu gom lÃ¡ bá»‡nh tiÃªu há»§y.",
      treatment: "Phun Daconil hoáº·c Score theo tá»· lá»‡ 1.5ml/lÃ­t nÆ°á»›c."
    },
    "KHá»E Máº NH": {
      symptoms: "LÃ¡ xanh Ä‘á»u, khÃ´ng cÃ³ váº¿t bá»‡nh.",
      causes: "Äiá»u kiá»‡n sinh trÆ°á»Ÿng tá»‘t.",
      prevention: "Tiáº¿p tá»¥c chÄƒm sÃ³c bÃ¬nh thÆ°á»ng.",
      care: "Duy trÃ¬ bÃ³n phÃ¢n vÃ  tÆ°á»›i nÆ°á»›c há»£p lÃ½.",
      treatment: "KhÃ´ng cáº§n xá»­ lÃ½ thÃªm."
    }
  };

  const video = document.getElementById('webcam');
  const preview = document.getElementById('preview');
  const startBtn = document.getElementById('startBtn');
  const switchBtn = document.getElementById('switchBtn');
  const stopBtn = document.getElementById('stopBtn');
  const captureBtn = document.getElementById('captureBtn');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const detailsBtn = document.getElementById('detailsBtn');
  const resultDiv = document.getElementById('result');
  const detailsDiv = document.getElementById('details');
  const symptomsEl = document.getElementById('symptoms');
  const causesEl = document.getElementById('causes');
  const preventionEl = document.getElementById('prevention');
  const careEl = document.getElementById('care');
  const treatmentEl = document.getElementById('treatment');

  // Giá»ng nÃ³i
  function speak(text){
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'vi-VN';
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }

  // Táº£i mÃ´ hÃ¬nh
  async function loadModel(){
    try {
      resultDiv.innerText = "â³ Äang táº£i mÃ´ hÃ¬nh...";
      await tf.ready();
      model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
      resultDiv.innerText = "âœ… MÃ´ hÃ¬nh sáºµn sÃ ng. Nháº¥n Báº­t camera.";
      speak("MÃ´ hÃ¬nh Ä‘Ã£ sáºµn sÃ ng, nháº¥n báº­t camera Ä‘á»ƒ báº¯t Ä‘áº§u.");
    } catch (e) {
      resultDiv.innerText = "âŒ Lá»—i khi táº£i mÃ´ hÃ¬nh.";
      console.error(e);
    }
  }
  loadModel();

  // Liá»‡t kÃª camera
  async function listVideoDevices(){
    videoDevices = (await navigator.mediaDevices.enumerateDevices()).filter(d => d.kind === 'videoinput');
  }

  // Báº­t camera
  async function startCamera(preferBack = true){
    try {
      await listVideoDevices();
      let constraints;
      if(videoDevices.length > 0){
        let back = videoDevices.find(d => /back|environment/i.test(d.label));
        if(preferBack && back){
          currentDeviceId = back.deviceId;
          constraints = { video: { deviceId: { exact: currentDeviceId } } };
        } else constraints = { video: { facingMode: "environment" } };
      } else constraints = { video: true };

      if(stream){ stopCamera(); }
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      captureBtn.disabled = false;
      stopBtn.disabled = false;
      switchBtn.disabled = videoDevices.length < 2;
      startBtn.disabled = true;
      resultDiv.innerText = "ğŸ“¸ Camera Ä‘Ã£ báº­t, báº¡n cÃ³ thá»ƒ chá»¥p áº£nh.";
      speak("Camera Ä‘Ã£ báº­t, báº¡n cÃ³ thá»ƒ chá»¥p áº£nh.");
    } catch (err) {
      console.error(err);
      alert("âš ï¸ KhÃ´ng thá»ƒ báº­t camera. HÃ£y má»Ÿ file nÃ y báº±ng Chrome vÃ  cho phÃ©p truy cáº­p camera.");
      speak("KhÃ´ng thá»ƒ báº­t camera. HÃ£y má»Ÿ báº±ng trÃ¬nh duyá»‡t Chrome vÃ  cáº¥p quyá»n camera.");
    }
  }

  // Táº¯t camera
  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    captureBtn.disabled = true;
    analyzeBtn.disabled = true;
    resultDiv.innerText = "ğŸ›‘ Camera Ä‘Ã£ táº¯t.";
  }

  // Chuyá»ƒn camera
  async function switchCamera(){
    if(videoDevices.length < 2) return;
    let idx = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
    currentDeviceId = videoDevices[(idx + 1) % videoDevices.length].deviceId;
    await startCamera(false);
  }

  // Chá»¥p áº£nh
  function captureImage(){
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    preview.src = canvas.toDataURL('image/jpeg');
    preview.style.display = 'block';
    analyzeBtn.disabled = false;
    resultDiv.innerText = "ğŸ“· áº¢nh Ä‘Ã£ chá»¥p, nháº¥n PhÃ¢n tÃ­ch.";
    speak("áº¢nh Ä‘Ã£ chá»¥p, nháº¥n phÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.");
  }

  // PhÃ¢n tÃ­ch áº£nh
  async function analyzeImage(){
    if(!model){
      resultDiv.innerText = "âš ï¸ MÃ´ hÃ¬nh chÆ°a sáºµn sÃ ng.";
      speak("MÃ´ hÃ¬nh chÆ°a sáºµn sÃ ng, vui lÃ²ng Ä‘á»£i.");
      return;
    }
    if(!preview.src){
      resultDiv.innerText = "âš ï¸ Báº¡n cáº§n chá»¥p áº£nh trÆ°á»›c khi phÃ¢n tÃ­ch.";
      speak("Báº¡n cáº§n chá»¥p áº£nh trÆ°á»›c khi phÃ¢n tÃ­ch.");
      return;
    }
    resultDiv.innerText = "ğŸ” Äang phÃ¢n tÃ­ch...";
    speak("Äang phÃ¢n tÃ­ch áº£nh, vui lÃ²ng Ä‘á»£i.");

    await new Promise(r => preview.complete ? r() : preview.onload = r);

    const prediction = await model.predict(preview);
    prediction.sort((a,b) => b.probability - a.probability);
    const top = prediction[0];
    const className = top.className.toUpperCase();
    const confidence = (top.probability * 100).toFixed(1);
    resultDiv.innerText = `Káº¿t luáº­n: ${className} (${confidence}%)`;
    speak(`Káº¿t luáº­n ${className}, Ä‘á»™ tin cáº­y ${confidence} pháº§n trÄƒm.`);
    showDetails(className);
  }

  function showDetails(className){
    const data = diseaseDetails[className];
    if(!data){ detailsDiv.style.display = 'none'; return; }
    symptomsEl.innerText = data.symptoms;
    causesEl.innerText = data.causes;
    preventionEl.innerText = data.prevention;
    careEl.innerText = data.care;
    treatmentEl.innerText = data.treatment;
    detailsDiv.style.display = 'block';
    detailsBtn.disabled = false;
  }

  // Sá»± kiá»‡n
  startBtn.onclick = () => startCamera();
  switchBtn.onclick = () => switchCamera();
  stopBtn.onclick = () => stopCamera();
  captureBtn.onclick = () => captureImage();
  analyzeBtn.onclick = () => analyzeImage();
  detailsBtn.onclick = () => {
    detailsDiv.style.display = detailsDiv.style.display === 'block' ? 'none' : 'block';
  };
  </script>
</body>
</html>
