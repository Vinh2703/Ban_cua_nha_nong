<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>á»¨ng dá»¥ng AI Báº¡n cá»§a nhÃ  nÃ´ng</title>

  <!-- TensorFlow & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; background: linear-gradient(135deg,#f1f8e9,#c8e6c9); text-align:center; padding:14px; }
    h1 { color:#1b5e20; margin:6px 0 10px; font-size:22px; }
    video, img { width:94%; max-width:420px; border-radius:12px; border:3px solid #4caf50; margin:8px auto; display:block; }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:6px; }
    button { display:block; margin:8px auto; padding:12px 18px; font-size:18px; border-radius:10px; border:none; background:#43a047; color:#fff; cursor:pointer; width:90%; max-width:420px; }
    button.secondary { background:#fff; color:#2e7d32; border:2px solid #4caf50; }
    button:disabled { background:#ccc; color:#666; cursor:not-allowed; }
    #result { margin-top:12px; font-size:18px; font-weight:700; color:#1b5e20; }
    #details { display:none; background:#fff; margin:14px auto; padding:12px; border-radius:10px; max-width:420px; text-align:left; box-shadow:0 2px 8px rgba(0,0,0,0.12); }
    #details h3 { color:#2e7d32; margin-bottom:8px; text-align:center; }
    #details p { margin:6px 0; font-size:16px; color:#2e2e2e; }
    .small { font-size:13px; color:#4b6b4b; margin-top:6px; }
  </style>
</head>
<body>
  <h1>ğŸŒ¾ á»¨ng dá»¥ng AI Báº¡n cá»§a nhÃ  nÃ´ng</h1>

  <!-- muted + playsinline giÃºp mobile play nhanh hÆ¡n -->
  <video id="webcam" autoplay playsinline muted></video>
  <img id="preview" style="display:none">

  <div class="row">
    <button id="startBtn">ğŸ“· Báº­t camera</button>
    <button id="switchBtn" class="secondary" disabled>ğŸ”„ Äá»•i camera</button>
  </div>

  <div class="row">
    <button id="captureBtn" disabled>ğŸ–¼ï¸ Chá»¥p áº£nh</button>
    <button id="analyzeBtn" disabled>ğŸ¤– PhÃ¢n tÃ­ch bá»‡nh</button>
  </div>

  <div class="row">
    <button id="detailsBtn" disabled>ğŸ“– Xem chi tiáº¿t</button>
    <button id="speakBtn" disabled>ğŸ”Š Nghe láº¡i thÃ´ng tin bá»‡nh</button>
  </div>

  <div id="result">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>

  <div id="details">
    <h3>ğŸ“˜ ThÃ´ng tin chi tiáº¿t</h3>
    <p><b>Biá»ƒu hiá»‡n:</b> <span id="symptoms"></span></p>
    <p><b>NguyÃªn nhÃ¢n:</b> <span id="causes"></span></p>
    <p><b>PhÃ²ng ngá»«a:</b> <span id="prevention"></span></p>
    <p><b>ChÄƒm sÃ³c:</b> <span id="care"></span></p>
    <p><b>Äiá»u trá»‹:</b> <span id="treatment"></span></p>
  </div>

<script>
/* --------- CONFIG ---------- */
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
let model = null;
let stream = null;
let devices = [];
let currentDeviceId = null;
let lastClassName = null; // => Vietnamese display name (key to diseaseDetails)
let ttsUnlocked = false;  // whether TTS has been unlocked by a user gesture

/* --------- MAPPING & DATA (replace/extend as needed) ---------- */
const nameMap = {
  "BENH_KHO_VAN": "Bá»‡nh khÃ´ váº±n",
  "BENH_DOM_LA_LON": "Bá»‡nh Ä‘á»‘m lÃ¡ lá»›n",
  "BENH_PHAN_DEN": "Bá»‡nh pháº¥n Ä‘en",
  "CAY_NGO_KHOE": "CÃ¢y ngÃ´ khá»e"
};

const diseaseDetails = {
  "Bá»‡nh khÃ´ váº±n": {
    symptoms: "Váº¿t loang xÃ¡m tro trÃªn báº¹ lÃ¡ vÃ  thÃ¢n, hÃ¬nh dáº¡ng báº¥t Ä‘á»‹nh. Bá»‡nh lan tá»« gá»‘c lÃªn báº¯p lÃ m lÃ¡ vÃ ng khÃ´ vÃ  cÃ¢y cháº¿t dáº§n.",
    causes: "Do náº¥m Rhizoctonia solani Kuhn, phÃ¡t triá»ƒn máº¡nh trong Ä‘iá»u kiá»‡n áº©m cao, nhiá»‡t Ä‘á»™ 25â€“30Â°C.",
    prevention: "Chá»n giá»‘ng Ã­t nhiá»…m, gieo Ä‘Ãºng thá»i vá»¥, vá»‡ sinh Ä‘á»“ng ruá»™ng, tiÃªu há»§y tÃ n dÆ° cÃ¢y bá»‡nh.",
    care: "Giá»¯ ruá»™ng thÃ´ng thoÃ¡ng, khÃ´ng bÃ³n thá»«a Ä‘áº¡m, dÃ¹ng cháº¿ pháº©m Trichoderma.",
    treatment: "Phun thuá»‘c Anvil, Azotide, Tilt Super hoáº·c Evitin theo hÆ°á»›ng dáº«n."
  },
  "Bá»‡nh Ä‘á»‘m lÃ¡ lá»›n": {
    symptoms: "TrÃªn lÃ¡ xuáº¥t hiá»‡n Ä‘á»‘m báº§u dá»¥c hoáº·c thoi, nÃ¢u nháº¡t Ä‘áº¿n nÃ¢u Ä‘áº­m, giá»¯a Ä‘á»‘m xÃ¡m tro. Khi áº©m Æ°á»›t, bá»‡nh lan nhanh lÃ m lÃ¡ khÃ´ chÃ¡y.",
    causes: "Do náº¥m Exserohilum turcicum, phÃ¡t triá»ƒn máº¡nh khi thá»i tiáº¿t nÃ³ng áº©m.",
    prevention: "LuÃ¢n canh cÃ¢y trá»“ng, dá»n sáº¡ch tÃ n dÆ°, bÃ³n phÃ¢n cÃ¢n Ä‘á»‘i.",
    care: "Giáº£m Ä‘áº¡m, tÄƒng kali, phun cháº¿ pháº©m sinh há»c phÃ²ng bá»‡nh.",
    treatment: "Phun Daconil, Score hoáº·c Tilt khi bá»‡nh lan rá»™ng."
  },
  "Bá»‡nh pháº¥n Ä‘en": {
    symptoms: "Xuáº¥t hiá»‡n u sÆ°ng tráº¯ng trÃªn báº¹ lÃ¡, thÃ¢n, báº¯p. BÃªn trong chá»©a bá»™t Ä‘en lÃ  bÃ o tá»­ náº¥m.",
    causes: "Do náº¥m Ustilago maydis hoáº·c Ustilago zeae gÃ¢y ra, phÃ¡t tÃ¡n qua giÃ³, nÆ°á»›c, váº¿t thÆ°Æ¡ng.",
    prevention: "LuÃ¢n canh cÃ¢y trá»“ng, xá»­ lÃ½ háº¡t giá»‘ng, dá»n sáº¡ch tÃ n dÆ° cÃ¢y bá»‡nh.",
    care: "Cáº¯t bá» pháº§n bá»‹ bá»‡nh, tÄƒng cÆ°á»ng bÃ³n kali vÃ  há»¯u cÆ¡.",
    treatment: "Phun Antafungal hoáº·c thuá»‘c chá»©a tebuconazole, propiconazole, hexaconazole."
  },
  "CÃ¢y ngÃ´ khá»e": {
    symptoms: "LÃ¡ xanh bÃ³ng, khÃ´ng cÃ³ Ä‘á»‘m bá»‡nh hay pháº¥n phá»§.",
    causes: "CÃ¢y phÃ¡t triá»ƒn trong Ä‘iá»u kiá»‡n sinh trÆ°á»Ÿng tá»‘t.",
    prevention: "Duy trÃ¬ tÆ°á»›i tiÃªu há»£p lÃ½, bÃ³n phÃ¢n cÃ¢n Ä‘á»‘i.",
    care: "Giá»¯ ruá»™ng thÃ´ng thoÃ¡ng, trÃ¡nh ngáº­p Ãºng.",
    treatment: "KhÃ´ng cáº§n xá»­ lÃ½ thÃªm."
  }
};

/* --------- Elements -------- */
const videoEl = document.getElementById('webcam');
const previewEl = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const detailsBtn = document.getElementById('detailsBtn');
const speakBtn = document.getElementById('speakBtn');
const resultDiv = document.getElementById('result');
const detailsBox = document.getElementById('details');
const symptomsEl = document.getElementById('symptoms');
const causesEl = document.getElementById('causes');
const preventionEl = document.getElementById('prevention');
const careEl = document.getElementById('care');
const treatmentEl = document.getElementById('treatment');

/* --------- TTS helper & unlock on user gesture -------- */
function speak(text){
  try{
    if(!('speechSynthesis' in window)) return;
    // if not unlocked yet, try to unlock with a short phrase (must be in user gesture)
    if(!ttsUnlocked){
      // do a short phrase to unlock â€” this should be called inside a user click handler
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance('á»¨ng dá»¥ng Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ Ä‘á»c.');
      u.lang = 'vi-VN';
      u.rate = 0.95;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
      ttsUnlocked = true;
      // continue to speak the desired text slightly delayed
      setTimeout(() => {
        const u2 = new SpeechSynthesisUtterance(text);
        u2.lang = 'vi-VN';
        u2.rate = 0.95;
        u2.pitch = 1.0;
        window.speechSynthesis.speak(u2);
      }, 350);
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'vi-VN';
    u.rate = 0.95;
    u.pitch = 1.0;
    window.speechSynthesis.speak(u);
  }catch(e){
    console.warn('TTS error', e);
  }
}

/* --------- Load model (async) -------- */
async function loadModel(){
  resultDiv.innerText = 'â³ Äang táº£i mÃ´ hÃ¬nh...';
  try{
    await tf.ready();
    model = await tmImage.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
    resultDiv.innerText = 'âœ… MÃ´ hÃ¬nh sáºµn sÃ ng. Nháº¥n "Báº­t camera" Ä‘á»ƒ báº¯t Ä‘áº§u.';
    console.log('Model loaded');
    // enumerate devices early so we can enable switch if >1
    await enumerateVideoDevices();
  }catch(err){
    console.error('Load model err', err);
    resultDiv.innerText = 'âŒ Lá»—i táº£i mÃ´ hÃ¬nh';
  }
}
loadModel();

/* --------- Devices & camera functions -------- */
async function enumerateVideoDevices(){
  try{
    const all = await navigator.mediaDevices.enumerateDevices();
    devices = all.filter(d => d.kind === 'videoinput');
    switchBtn.disabled = devices.length < 2;
  }catch(e){
    console.warn('enumerateDevices', e);
    devices = [];
    switchBtn.disabled = true;
  }
}

async function startCamera(preferBack = true){
  try{
    // user gesture: try to unlock TTS here by speaking once (short)
    if(!ttsUnlocked){
      ttsUnlocked = true;
      // small silent utterance may be blocked, so speak short message
      window.speechSynthesis.cancel();
      const u0 = new SpeechSynthesisUtterance(''); // some browsers accept empty; safe fallback below
      u0.lang = 'vi-VN';
      try { window.speechSynthesis.speak(u0); } catch(e){ /*ignore*/ }
    }

    await enumerateVideoDevices();
    let constraints;
    if(devices.length > 0){
      const back = devices.find(d => /back|rear|environment/i.test(d.label));
      if(preferBack && back){
        currentDeviceId = back.deviceId;
        constraints = { video: { deviceId: { exact: currentDeviceId } } };
      } else {
        // fallback to facingMode
        constraints = { video: { facingMode: { ideal: 'environment' } } };
      }
    } else {
      constraints = { video: true };
    }

    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream;

    // wait until metadata loaded and video has dimensions
    await new Promise(resolve => {
      const onLoaded = () => {
        const check = () => {
          if(videoEl.videoWidth && videoEl.videoHeight) resolve();
          else requestAnimationFrame(check);
        };
        check();
      };
      videoEl.onloadedmetadata = onLoaded;
      setTimeout(resolve, 2000); // fallback
    });

    captureBtn.disabled = false;
    analyzeBtn.disabled = true;
    detailsBtn.disabled = true;
    speakBtn.disabled = true;
    startBtn.disabled = true;

    resultDiv.innerText = 'ğŸ“¸ Camera Ä‘Ã£ báº­t. HÆ°á»›ng lÃ¡ ngÃ´ vÃ o khung hÃ¬nh vÃ  chá»¥p áº£nh.';
    speak('Camera Ä‘Ã£ báº­t. HÆ°á»›ng lÃ¡ ngÃ´ vÃ o khung hÃ¬nh vÃ  chá»¥p áº£nh.');

    await enumerateVideoDevices(); // refresh labels
    switchBtn.disabled = devices.length < 2;
  }catch(err){
    console.error('startCamera err', err);
    alert('âš ï¸ KhÃ´ng thá»ƒ báº­t camera. HÃ£y má»Ÿ báº±ng Chrome vÃ  cáº¥p quyá»n camera.');
    resultDiv.innerText = 'âŒ KhÃ´ng thá»ƒ báº­t camera';
  }
}

async function switchCamera(){
  if(devices.length < 2) return;
  const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
  const next = devices[(idx + 1) % devices.length] || devices[0];
  currentDeviceId = next.deviceId;
  await startCamera(false);
}

/* --------- Capture image: wait for video readiness -------- */
async function captureImage(){
  if(!stream){
    alert('ChÆ°a báº­t camera. Nháº¥n Báº­t camera trÆ°á»›c khi chá»¥p.');
    return;
  }
  // wait until video has size
  if(!videoEl.videoWidth || !videoEl.videoHeight){
    await new Promise(res => {
      const check = () => {
        if(videoEl.videoWidth && videoEl.videoHeight) res();
        else requestAnimationFrame(check);
      };
      check();
    });
  }

  const canvas = document.createElement('canvas');
  canvas.width = videoEl.videoWidth;
  canvas.height = videoEl.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
  previewEl.src = canvas.toDataURL('image/jpeg', 0.92);
  previewEl.style.display = 'block';

  analyzeBtn.disabled = false;
  detailsBtn.disabled = true;
  speakBtn.disabled = true;
  resultDiv.innerText = 'ğŸ–¼ï¸ áº¢nh Ä‘Ã£ chá»¥p. Nháº¥n PhÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.';
  speak('áº¢nh Ä‘Ã£ chá»¥p. Nháº¥n phÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.');
}

/* --------- Normalize label helper -------- */
function normalizeLabel(label){
  if(!label) return '';
  // to uppercase, trim, decompose and remove diacritics, replace spaces with underscore
  const noDiacrit = label.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return noDiacrit.trim().toUpperCase().replace(/\s+/g, '_').replace(/[^A-Z0-9_]/g,'');
}

/* --------- Analyze image -------- */
async function analyzeImage(){
  if(!model){
    alert('MÃ´ hÃ¬nh chÆ°a sáºµn sÃ ng. Vui lÃ²ng Ä‘á»£i.');
    return;
  }
  if(!previewEl.src){
    alert('Báº¡n cáº§n chá»¥p áº£nh trÆ°á»›c khi phÃ¢n tÃ­ch.');
    return;
  }
  resultDiv.innerText = 'ğŸ” Äang phÃ¢n tÃ­ch...';
  try{
    await new Promise(res => previewEl.complete ? res() : previewEl.onload = res);
    const predictions = await model.predict(previewEl);
    if(!Array.isArray(predictions) || predictions.length === 0) throw new Error('No predictions');
    predictions.sort((a,b) => b.probability - a.probability);
    const top = predictions[0];
    const raw = String(top.className || '');
    const norm = normalizeLabel(raw); // e.g., BENH_PHAN_DEN
    // try mapping by several variants
    let name = nameMap[norm] || nameMap[raw.toUpperCase()] || nameMap[raw] || null;
    // if still null, try human-friendly fallback: capitalize raw
    if(!name){
      name = raw.trim();
    }
    const conf = (top.probability * 100).toFixed(1);
    resultDiv.innerText = `Káº¿t luáº­n: ${name} (${conf}%)`;
    // Attempt to speak - unlock if needed (user gesture already occurred earlier)
    speak(`Káº¿t luáº­n: ${name}. Äá»™ tin cáº­y ${conf} pháº§n trÄƒm.`);
    lastClassName = name;
    // prepare details content
    showDetails(name); // populate content (may be empty if not found)
    // enable buttons only when we have something meaningful
    detailsBtn.disabled = false;
    speakBtn.disabled = false;
    analyzeBtn.disabled = false;
  }catch(err){
    console.error('analyze err', err);
    resultDiv.innerText = 'âŒ Lá»—i khi phÃ¢n tÃ­ch';
    speak('Lá»—i khi phÃ¢n tÃ­ch áº£nh. Vui lÃ²ng thá»­ láº¡i.');
  }
}

/* --------- Fill detail fields (but don't auto-show) -------- */
function showDetails(name){
  const info = diseaseDetails[name];
  if(!info){
    // clear fields if no info
    symptomsEl.textContent = '';
    causesEl.textContent = '';
    preventionEl.textContent = '';
    careEl.textContent = '';
    treatmentEl.textContent = '';
    return false;
  }
  symptomsEl.textContent = info.symptoms;
  causesEl.textContent = info.causes;
  preventionEl.textContent = info.prevention;
  careEl.textContent = info.care;
  treatmentEl.textContent = info.treatment;
  return true;
}

/* --------- Details button: toggle content and read when shown -------- */
detailsBtn.addEventListener('click', () => {
  if(!lastClassName){
    alert('Báº¡n chÆ°a phÃ¢n tÃ­ch áº£nh. Vui lÃ²ng phÃ¢n tÃ­ch trÆ°á»›c.');
    return;
  }
  // ensure content is ready
  const ok = showDetails(lastClassName);
  if(!ok){
    alert('ChÆ°a cÃ³ thÃ´ng tin chi tiáº¿t cho káº¿t quáº£ nÃ y.');
    return;
  }
  if(detailsBox.style.display === 'block'){
    detailsBox.style.display = 'none';
  } else {
    detailsBox.style.display = 'block';
    // speak details (also ensures TTS flow)
    const d = diseaseDetails[lastClassName];
    if(d) speak(`Biá»ƒu hiá»‡n: ${d.symptoms}. NguyÃªn nhÃ¢n: ${d.causes}. PhÃ²ng ngá»«a: ${d.prevention}. ChÄƒm sÃ³c: ${d.care}. Äiá»u trá»‹: ${d.treatment}.`);
  }
});

/* --------- Speak button: read details again -------- */
speakBtn.addEventListener('click', () => {
  if(!lastClassName){
    alert('ChÆ°a cÃ³ káº¿t quáº£ phÃ¢n tÃ­ch. Vui lÃ²ng phÃ¢n tÃ­ch trÆ°á»›c.');
    return;
  }
  const d = diseaseDetails[lastClassName];
  if(!d){
    alert('KhÃ´ng cÃ³ thÃ´ng tin chi tiáº¿t cho káº¿t quáº£ nÃ y.');
    return;
  }
  speak(`Biá»ƒu hiá»‡n: ${d.symptoms}. NguyÃªn nhÃ¢n: ${d.causes}. PhÃ²ng ngá»«a: ${d.prevention}. ChÄƒm sÃ³c: ${d.care}. Äiá»u trá»‹: ${d.treatment}.`);
});

/* --------- Wire up buttons -------- */
startBtn.addEventListener('click', () => {
  // start camera is a user gesture â€” good moment to unlock TTS
  startCamera();
});
switchBtn.addEventListener('click', () => switchCamera());
captureBtn.addEventListener('click', () => captureImage());
analyzeBtn.addEventListener('click', () => analyzeImage());

/* --------- initial UI state -------- */
(function init(){
  captureBtn.disabled = true;
  analyzeBtn.disabled = true;
  detailsBtn.disabled = true;
  speakBtn.disabled = true;
  switchBtn.disabled = true;
})();
</script>
</body>
</html>
