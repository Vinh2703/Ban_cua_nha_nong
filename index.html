<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Nh·∫≠n di·ªán b·ªánh tr√™n l√° ‚Äî Phi√™n b·∫£n s·ª≠a l·ªói</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: linear-gradient(135deg,#e8f5e9,#c8e6c9); text-align:center; padding:12px;}
    h1 { color:#2e7d32; margin-bottom:6px;}
    video, img { width:90%; max-width:360px; border-radius:10px; border:2px solid #81c784; margin-top:10px; }
    button { margin:5px; padding:10px 14px; font-size:15px; border-radius:8px; border:none; background:#66bb6a; color:#fff; cursor:pointer; }
    button:disabled { background:#ccc; cursor:not-allowed; color:#666;}
    #result { margin-top:12px; font-size:18px; font-weight:700; color:#1b5e20; }
    #details { background:#f1f8e9; margin-top:10px; padding:10px; border-radius:8px; display:none; text-align:left; max-width:720px; margin-left:auto; margin-right:auto; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    #details table { width:100%; border-collapse:collapse; }
    #details th { text-align:left; vertical-align:top; padding:6px 8px; color:#2e7d32; width:30%; }
    #details td { padding:6px 8px; border-bottom:1px solid #dcedc8; }
    .muted { color:#666; font-size:14px; }
    .small { font-size:13px; color:#444; }
  </style>
</head>
<body>
  <h1>üåø AI Nh·∫≠n di·ªán b·ªánh tr√™n l√° ‚Äî B·∫£n v√°</h1>

  <video id="webcam" autoplay playsinline></video>
  <img id="preview" style="display:none;" alt="·∫¢nh ch·ª•p">

  <div style="margin-top:8px">
    <button id="startBtn">üì∑ B·∫≠t camera</button>
    <button id="switchBtn" disabled>üîÑ ƒê·ªïi camera</button>
    <button id="stopBtn" disabled>üõë T·∫Øt camera</button>
    <button id="captureBtn" disabled>üì∏ Ch·ª•p ·∫£nh</button>
    <button id="analyzeBtn" disabled>ü§ñ Ph√¢n t√≠ch</button>
    <button id="detailsBtn" disabled>üìñ Xem chi ti·∫øt</button>
  </div>

  <div id="result">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

  <div id="details" aria-live="polite">
    <h3 style="margin-top:0">Chi ti·∫øt b·ªánh:</h3>
    <div id="detailsTableContainer" class="small"></div>
  </div>

<script>
/* -------------------------
   C·∫•u h√¨nh m√¥ h√¨nh
   ------------------------- */
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
let model = null;
let stream = null;
let videoDevices = [];
let currentDeviceId = null;
let lastClassName = null; // l∆∞u nh√£n cu·ªëi c√πng (chu·∫©n h√≥a UPPERCASE)

/* -------------------------
   D·ªØ li·ªáu b·ªánh
   L∆∞u √Ω: key l√† UPPERCASE
   ------------------------- */
const diseaseDetails = {
  "B·ªÜNH ƒê·ªêM N√ÇU": {
    symptoms: "Xu·∫•t hi·ªán c√°c ƒë·ªëm n√¢u tr√≤n, sau lan r·ªông l√†m kh√¥ l√°.",
    causes: "N·∫•m Cercospora sp ph√°t tri·ªÉn trong ƒëi·ªÅu ki·ªán ·∫©m ∆∞·ªõt.",
    prevention: "Kh√¥ng t∆∞·ªõi qu√° ·∫©m, t·ªâa th∆∞a l√°, lu√¢n canh c√¢y tr·ªìng.",
    care: "Gi·ªØ v∆∞·ªùn th√¥ng tho√°ng, lo·∫°i b·ªè l√° b·ªánh.",
    treatment: "Phun thu·ªëc g·ªëc ƒë·ªìng ho·∫∑c Mancozeb theo h∆∞·ªõng d·∫´n."
  },
  "B·ªÜNH KH√î L√Å": {
    symptoms: "L√° kh√¥ t·ª´ m√©p v√†o, chuy·ªÉn v√†ng, d·ªÖ r·ª•ng.",
    causes: "Do n·∫•m Alternaria sp g√¢y ra.",
    prevention: "Tr√°nh t∆∞·ªõi n∆∞·ªõc l√™n l√°, ki·ªÉm so√°t ƒë·ªô ·∫©m.",
    care: "Thu gom l√° b·ªánh ti√™u h·ªßy.",
    treatment: "Phun Daconil ho·∫∑c Score theo t·ª∑ l·ªá 1.5ml/l√≠t n∆∞·ªõc."
  },
  "KH·ªéE M·∫†NH": {
    symptoms: "L√° xanh ƒë·ªÅu, kh√¥ng c√≥ v·∫øt b·ªánh.",
    causes: "ƒêi·ªÅu ki·ªán sinh tr∆∞·ªüng t·ªët.",
    prevention: "Ti·∫øp t·ª•c chƒÉm s√≥c b√¨nh th∆∞·ªùng.",
    care: "Duy tr√¨ b√≥n ph√¢n v√† t∆∞·ªõi n∆∞·ªõc h·ª£p l√Ω.",
    treatment: "Kh√¥ng c·∫ßn x·ª≠ l√Ω th√™m."
  }
};

/* -------------------------
   Element refs
   ------------------------- */
const video = document.getElementById('webcam');
const preview = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const stopBtn = document.getElementById('stopBtn');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const detailsBtn = document.getElementById('detailsBtn');
const resultDiv = document.getElementById('result');
const detailsDiv = document.getElementById('details');
const detailsTableContainer = document.getElementById('detailsTableContainer');

/* -------------------------
   Text-to-speech helper
   ------------------------- */
function speak(text){
  try {
    if(!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(String(text));
    u.lang = 'vi-VN';
    speechSynthesis.speak(u);
  } catch (e) {
    console.warn("Speech error:", e);
  }
}

/* -------------------------
   Load model
   ------------------------- */
async function loadModel(){
  try {
    resultDiv.innerText = "‚è≥ ƒêang t·∫£i m√¥ h√¨nh...";
    await tf.ready();
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    resultDiv.innerText = "‚úÖ M√¥ h√¨nh s·∫µn s√†ng. Nh·∫•n B·∫≠t camera.";
    speak("M√¥ h√¨nh ƒë√£ s·∫µn s√†ng, nh·∫•n b·∫≠t camera ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
    console.log("Model loaded.");
  } catch (e) {
    resultDiv.innerText = "‚ùå L·ªói khi t·∫£i m√¥ h√¨nh.";
    console.error("Error loading model:", e);
    alert("L·ªói khi t·∫£i m√¥ h√¨nh. Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n ho·∫∑c k·∫øt n·ªëi m·∫°ng.");
  }
}
loadModel();

/* -------------------------
   Camera helpers
   ------------------------- */
async function listVideoDevices(){
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d => d.kind === 'videoinput');
    console.log("videoDevices:", videoDevices);
  } catch (e) {
    console.warn("enumerateDevices failed:", e);
    videoDevices = [];
  }
}

async function startCamera(preferBack = true){
  try {
    await listVideoDevices();
    let constraints;
    if (videoDevices.length > 0){
      const back = videoDevices.find(d => /back|environment/i.test(d.label));
      if (preferBack && back){
        currentDeviceId = back.deviceId;
        constraints = { video: { deviceId: { exact: currentDeviceId } } };
      } else {
        constraints = { video: { facingMode: "environment" } };
      }
    } else {
      constraints = { video: true };
    }

    if (stream) stopCamera();
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    captureBtn.disabled = false;
    switchBtn.disabled = (videoDevices.length < 2);
    resultDiv.innerText = "üì∏ Camera ƒë√£ b·∫≠t, b·∫°n c√≥ th·ªÉ ch·ª•p ·∫£nh.";
    speak("Camera ƒë√£ b·∫≠t, b·∫°n c√≥ th·ªÉ ch·ª•p ·∫£nh.");
  } catch (err){
    console.error("startCamera error:", err);
    alert("‚ö†Ô∏è Kh√¥ng th·ªÉ b·∫≠t camera. M·ªü b·∫±ng Chrome/Edge v√† c·∫•p quy·ªÅn camera.");
    speak("Kh√¥ng th·ªÉ b·∫≠t camera. H√£y m·ªü b·∫±ng Chrome ho·∫∑c Edge v√† c·∫•p quy·ªÅn camera.");
  }
}

function stopCamera(){
  if (stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.srcObject = null;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  captureBtn.disabled = true;
  analyzeBtn.disabled = true;
  detailsBtn.disabled = true;
  preview.style.display = 'none';
  preview.src = '';
  resultDiv.innerText = "üõë Camera ƒë√£ t·∫Øt.";
  detailsDiv.style.display = 'none';
  lastClassName = null;
  console.log("Camera stopped.");
}

async function switchCamera(){
  if (videoDevices.length < 2) return;
  const idx = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
  const next = videoDevices[(idx + 1) % videoDevices.length];
  currentDeviceId = next.deviceId;
  await startCamera(false);
}

/* -------------------------
   Capture & Analyze
   ------------------------- */
function captureImage(){
  if (!video.videoWidth || !video.videoHeight){
    alert("·∫¢nh ch∆∞a s·∫µn s√†ng ‚Äî th·ª≠ l·∫°i.");
    return;
  }
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  preview.src = canvas.toDataURL('image/jpeg');
  preview.style.display = 'block';
  analyzeBtn.disabled = false;
  resultDiv.innerText = "üì∑ ·∫¢nh ƒë√£ ch·ª•p, nh·∫•n Ph√¢n t√≠ch.";
  speak("·∫¢nh ƒë√£ ch·ª•p, nh·∫•n ph√¢n t√≠ch ƒë·ªÉ xem k·∫øt qu·∫£.");
  // reset details area
  detailsDiv.style.display = 'none';
  detailsTableContainer.innerHTML = '';
  lastClassName = null;
  detailsBtn.disabled = true;
  console.log("Image captured.");
}

async function analyzeImage(){
  if (!model){
    resultDiv.innerText = "‚ö†Ô∏è M√¥ h√¨nh ch∆∞a s·∫µn s√†ng.";
    speak("M√¥ h√¨nh ch∆∞a s·∫µn s√†ng, vui l√≤ng ƒë·ª£i.");
    return;
  }
  if (!preview.src){
    resultDiv.innerText = "‚ö†Ô∏è B·∫°n c·∫ßn ch·ª•p ·∫£nh tr∆∞·ªõc khi ph√¢n t√≠ch.";
    speak("B·∫°n c·∫ßn ch·ª•p ·∫£nh tr∆∞·ªõc khi ph√¢n t√≠ch.");
    return;
  }
  resultDiv.innerText = "üîç ƒêang ph√¢n t√≠ch...";
  speak("ƒêang ph√¢n t√≠ch ·∫£nh, vui l√≤ng ƒë·ª£i.");
  // ƒë·∫£m b·∫£o ·∫£nh ƒë√£ load
  await new Promise(res => preview.complete ? res() : preview.onload = res);

  try {
    const predictions = await model.predict(preview);
    if (!Array.isArray(predictions) || predictions.length === 0){
      throw new Error("Model returned no predictions.");
    }
    predictions.sort((a,b) => b.probability - a.probability);
    const top = predictions[0];
    const raw = String(top.className || "").trim();
    const className = raw.toUpperCase();
    const confidence = (top.probability * 100).toFixed(1);

    console.log("Predictions:", predictions);
    resultDiv.innerText = `K·∫øt lu·∫≠n: ${className} (${confidence}%)`;
    speak(`K·∫øt lu·∫≠n ${className}, ƒë·ªô tin c·∫≠y ${confidence} ph·∫ßn trƒÉm.`);
    lastClassName = className;

    // N·∫øu c√≥ d·ªØ li·ªáu chi ti·∫øt => render v√† b·∫≠t n√∫t
    if (className in diseaseDetails){
      renderDetails(className);           // t·∫°o n·ªôi dung s·∫µn s√†ng
      detailsBtn.disabled = false;        // b·∫≠t n√∫t ƒë·ªÉ ng∆∞·ªùi d√πng xem
      // Optionally t·ª± m·ªü chi ti·∫øt ngay:
      // detailsDiv.style.display = 'block';
      // speakDetails(className);
    } else {
      // kh√¥ng c√≥ th√¥ng tin chi ti·∫øt
      detailsTableContainer.innerHTML = `<p class="muted">Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt cho k·∫øt lu·∫≠n "<b>${escapeHtml(className)}</b>".</p>`;
      detailsBtn.disabled = true;
      console.warn("No detail for:", className);
    }
  } catch (err){
    console.error("analyzeImage error:", err);
    resultDiv.innerText = "‚ùå L·ªói khi ph√¢n t√≠ch ·∫£nh.";
    speak("L·ªói khi ph√¢n t√≠ch ·∫£nh, vui l√≤ng th·ª≠ l·∫°i.");
  }
}

/* -------------------------
   Render chi ti·∫øt & ƒë·ªçc
   ------------------------- */
function renderDetails(className){
  const data = diseaseDetails[className];
  if (!data){
    detailsTableContainer.innerHTML = `<p class="muted">Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt.</p>`;
    return;
  }
  const html = `
    <table>
      <tr><th>Chu·∫©n ƒëo√°n</th><td>${escapeHtml(className)}</td></tr>
      <tr><th>Tri·ªáu ch·ª©ng</th><td>${escapeHtml(data.symptoms)}</td></tr>
      <tr><th>Nguy√™n nh√¢n</th><td>${escapeHtml(data.causes)}</td></tr>
      <tr><th>Ph√≤ng ng·ª´a</th><td>${escapeHtml(data.prevention)}</td></tr>
      <tr><th>ChƒÉm s√≥c</th><td>${escapeHtml(data.care)}</td></tr>
      <tr><th>ƒêi·ªÅu tr·ªã</th><td>${escapeHtml(data.treatment)}</td></tr>
    </table>
  `;
  detailsTableContainer.innerHTML = html;
}

/* ƒê·ªçc chi ti·∫øt: ƒë·ªçc c·∫£ ƒëo·∫°n d√†i (m·ªôt l·∫ßn) ƒë·ªÉ tr√°nh overlap */
function speakDetails(className){
  const data = diseaseDetails[className];
  if (!data) return;
  const text = `Chu·∫©n ƒëo√°n: ${className}. Tri·ªáu ch·ª©ng: ${data.symptoms}. Nguy√™n nh√¢n: ${data.causes}. C√°ch ph√≤ng ng·ª´a: ${data.prevention}. ChƒÉm s√≥c: ${data.care}. ƒêi·ªÅu tr·ªã: ${data.treatment}.`;
  speak(text);
}

/* Toggle t·∫°o h√†nh ƒë·ªông cho n√∫t details (ƒë·∫£m b·∫£o binding m·∫°nh m·∫Ω) */
detailsBtn.addEventListener('click', () => {
  try {
    if (!lastClassName) return;
    if (detailsDiv.style.display === 'block'){
      detailsDiv.style.display = 'none';
    } else {
      // n·∫øu c√≥ data, ƒë·∫£m b·∫£o ƒë√£ render
      if (lastClassName in diseaseDetails && detailsTableContainer.innerHTML.trim() === ''){
        renderDetails(lastClassName);
      }
      detailsDiv.style.display = 'block';
      speakDetails(lastClassName);
      // cu·ªôn xu·ªëng ph·∫ßn details ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y
      setTimeout(() => detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' }), 120);
    }
  } catch (e) {
    console.error("detailsBtn click error:", e);
  }
});

/* -------------------------
   Util helpers
   ------------------------- */
function escapeHtml(s){
  if (!s) return '';
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* -------------------------
   N√∫t bindings
   ------------------------- */
startBtn.addEventListener('click', () => startCamera());
switchBtn.addEventListener('click', () => switchCamera());
stopBtn.addEventListener('click', () => stopCamera());
captureBtn.addEventListener('click', () => captureImage());
analyzeBtn.addEventListener('click', () => analyzeImage());

/* -------------------------
   Debug: ghi h∆∞·ªõng d·∫´n console
   ------------------------- */
console.log("%cDebug: n·∫øu n√∫t Xem chi ti·∫øt kh√¥ng ho·∫°t ƒë·ªông, m·ªü DevTools -> Console v√† g·ª≠i log cho m√¨nh.", "color: #2e7d32; font-weight: bold;");
</script>
</body>
</html>
