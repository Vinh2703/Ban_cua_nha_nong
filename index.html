<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Nh·∫≠n di·ªán b·ªánh tr√™n l√° ng√¥</title>

  <!-- TensorFlow & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      text-align: center;
      padding: 10px;
    }

    h1 {
      color: #2e7d32;
      margin-bottom: 10px;
    }

    video, img {
      width: 95%;
      max-width: 400px;
      border-radius: 12px;
      border: 3px solid #4caf50;
      margin-top: 10px;
    }

    button {
      margin: 8px;
      padding: 14px 20px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      background: #43a047;
      color: white;
      cursor: pointer;
      width: 90%;
      max-width: 400px;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #result {
      margin-top: 15px;
      font-size: 20px;
      font-weight: bold;
      color: #1b5e20;
    }

    #details {
      background: #f1f8e9;
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      display: none;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #details h3 {
      color: #2e7d32;
      margin-bottom: 8px;
    }

    #details p {
      margin: 6px 0;
      font-size: 16px;
      color: #2e2e2e;
    }
  </style>
</head>

<body>
  <h1>üåΩ AI Nh·∫≠n di·ªán b·ªánh tr√™n l√° ng√¥</h1>

  <video id="webcam" autoplay playsinline></video>
  <img id="preview" style="display:none;">

  <div>
    <button id="startBtn">üì∑ B·∫≠t camera</button>
    <button id="captureBtn" disabled>üñºÔ∏è Ch·ª•p ·∫£nh</button>
    <button id="analyzeBtn" disabled>ü§ñ Ph√¢n t√≠ch b·ªánh</button>
    <button id="detailsBtn" disabled>üìñ Xem chi ti·∫øt</button>
  </div>

  <div id="result">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

  <div id="details">
    <h3>üìò Th√¥ng tin chi ti·∫øt</h3>
    <p><b>Bi·ªÉu hi·ªán:</b> <span id="symptoms"></span></p>
    <p><b>Nguy√™n nh√¢n:</b> <span id="causes"></span></p>
    <p><b>Ph√≤ng ng·ª´a:</b> <span id="prevention"></span></p>
    <p><b>ChƒÉm s√≥c:</b> <span id="care"></span></p>
    <p><b>ƒêi·ªÅu tr·ªã:</b> <span id="treatment"></span></p>
  </div>

  <script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
    let model = null, stream = null, currentDeviceId = null;
    let lastClassName = null;

    // üåæ B·∫£ng t√™n l·ªõp b·ªánh
    const nameMap = {
      "BENH_KHO_VAN": "B·ªánh kh√¥ v·∫±n",
      "BENH_DOM_LA_LON": "B·ªánh ƒë·ªëm l√° l·ªõn",
      "BENH_PHAN_DEN": "B·ªánh ph·∫•n ƒëen",
      "CAY_NGO_KHOE": "C√¢y ng√¥ kh·ªèe"
    };

    // üåø Th√¥ng tin chi ti·∫øt t·ª´ng b·ªánh
    const diseaseDetails = {
      "B·ªánh kh√¥ v·∫±n": {
        symptoms: "V·∫øt loang x√°m tro tr√™n b·∫π l√° v√† th√¢n, h√¨nh d·∫°ng b·∫•t ƒë·ªãnh nh∆∞ ƒë√°m m√¢y. V·∫øt b·ªánh lan d·∫ßn t·ª´ g·ªëc l√™n b·∫Øp, l√†m l√° v√†ng kh√¥ v√† c√¢y ch·∫øt d·∫ßn.",
        causes: "Do n·∫•m Rhizoctonia solani Kuhn g√¢y ra. Ph√°t tri·ªÉn m·∫°nh khi ·∫©m ƒë·ªô cao, nhi·ªát ƒë·ªô 25‚Äì30¬∞C.",
        prevention: "Ch·ªçn gi·ªëng √≠t nhi·ªÖm, gieo ƒë√∫ng th·ªùi v·ª•, tr·ªìng th∆∞a, v·ªá sinh ƒë·ªìng ru·ªông.",
        care: "Gi·ªØ ru·ªông th√¥ng tho√°ng, kh√¥ng b√≥n th·ª´a ƒë·∫°m, d√πng ch·∫ø ph·∫©m Trichoderma.",
        treatment: "Phun thu·ªëc Anvil 5SC, Azotide 30SC, Tilt Super 300EC, ho·∫∑c Evitin 50SC."
      },
      "B·ªánh ƒë·ªëm l√° l·ªõn": {
        symptoms: "Xu·∫•t hi·ªán ƒë·ªëm b·∫ßu d·ª•c n√¢u nh·∫°t, d√†i 10‚Äì15cm, gi·ªØa ƒë·ªëm x√°m tro. B·ªánh n·∫∑ng l√†m l√° kh√¥ ch√°y.",
        causes: "Do n·∫•m Exserohilum turcicum g√¢y ra, ph√°t tri·ªÉn m·∫°nh khi n√≥ng ·∫©m.",
        prevention: "Lu√¢n canh c√¢y tr·ªìng, d·ªçn t√†n d∆∞ c√¢y b·ªánh, b√≥n ph√¢n c√¢n ƒë·ªëi.",
        care: "B√≥n th√™m kali, gi·∫£m ƒë·∫°m, s·ª≠ d·ª•ng ch·∫ø ph·∫©m sinh h·ªçc.",
        treatment: "Phun Daconil, Score ho·∫∑c Tilt theo h∆∞·ªõng d·∫´n."
      },
      "B·ªánh ph·∫•n ƒëen": {
        symptoms: "Xu·∫•t hi·ªán c√°c n·ªët u s∆∞ng tr·∫Øng tr√™n b·∫π l√°, th√¢n, b·∫Øp. Sau ph√¨nh to, b√™n trong c√≥ b·ªôt ƒëen l√† b√†o t·ª≠ n·∫•m.",
        causes: "Do n·∫•m Ustilago maydis ho·∫∑c Ustilago zeae g√¢y ra. Ph√°t t√°n qua gi√≥ v√† n∆∞·ªõc.",
        prevention: "Lu√¢n canh c√¢y tr·ªìng, x·ª≠ l√Ω h·∫°t gi·ªëng, d·ªçn s·∫°ch t√†n d∆∞ c√¢y b·ªánh.",
        care: "C·∫Øt b·ªè ph·∫ßn b·ªã b·ªánh, tƒÉng b√≥n kali v√† h·ªØu c∆°.",
        treatment: "Phun Antafungal ho·∫∑c thu·ªëc c√≥ tebuconazole, propiconazole, hexaconazole."
      },
      "C√¢y ng√¥ kh·ªèe": {
        symptoms: "L√° xanh b√≥ng, kh√¥ng c√≥ ƒë·ªëm b·ªánh hay ph·∫•n ph·ªß.",
        causes: "C√¢y ph√°t tri·ªÉn trong ƒëi·ªÅu ki·ªán sinh tr∆∞·ªüng t·ªët.",
        prevention: "Duy tr√¨ t∆∞·ªõi ti√™u v√† b√≥n ph√¢n h·ª£p l√Ω.",
        care: "Gi·ªØ ru·ªông th√¥ng tho√°ng, ph√≤ng b·ªánh ƒë·ªãnh k·ª≥.",
        treatment: "Kh√¥ng c·∫ßn x·ª≠ l√Ω th√™m."
      }
    };

    // üé§ Gi·ªçng ƒë·ªçc ti·∫øng Vi·ªát
    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'vi-VN';
      utter.rate = 0.95;
      utter.pitch = 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(utter);
    }

    // üß† T·∫£i m√¥ h√¨nh
    async function loadModel() {
      resultDiv.innerText = "‚è≥ ƒêang t·∫£i m√¥ h√¨nh...";
      await tf.ready();
      model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
      resultDiv.innerText = "‚úÖ M√¥ h√¨nh s·∫µn s√†ng. Nh·∫•n B·∫≠t camera.";
      speak("M√¥ h√¨nh ƒë√£ s·∫µn s√†ng, b·∫°n c√≥ th·ªÉ b·∫≠t camera ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
    }

    // üé• B·∫≠t camera sau
    async function startCamera() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        const backCam = videoDevices.find(d => /back|environment/i.test(d.label)) || videoDevices[0];
        stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: backCam ? { exact: backCam.deviceId } : undefined }
        });
        webcam.srcObject = stream;
        captureBtn.disabled = false;
        analyzeBtn.disabled = true;
        resultDiv.innerText = "üì∏ Camera ƒë√£ b·∫≠t, h∆∞·ªõng l√° ng√¥ v√†o khung h√¨nh.";
        speak("Camera ƒë√£ b·∫≠t, h√£y h∆∞·ªõng l√° ng√¥ v√†o khung h√¨nh r·ªìi ch·ª•p ·∫£nh.");
      } catch (e) {
        alert("‚ö†Ô∏è Kh√¥ng th·ªÉ b·∫≠t camera. H√£y cho ph√©p truy c·∫≠p camera tr√™n tr√¨nh duy·ªát.");
      }
    }

    function stopCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      webcam.srcObject = null;
    }

    // üì∑ Ch·ª•p ·∫£nh
    function captureImage() {
      const canvas = document.createElement('canvas');
      canvas.width = webcam.videoWidth;
      canvas.height = webcam.videoHeight;
      canvas.getContext('2d').drawImage(webcam, 0, 0);
      preview.src = canvas.toDataURL('image/jpeg');
      preview.style.display = 'block';
      analyzeBtn.disabled = false;
      resultDiv.innerText = "üñºÔ∏è ·∫¢nh ƒë√£ ch·ª•p, nh·∫•n Ph√¢n t√≠ch ƒë·ªÉ xem k·∫øt qu·∫£.";
      speak("·∫¢nh ƒë√£ ƒë∆∞·ª£c ch·ª•p, b·∫•m ph√¢n t√≠ch ƒë·ªÉ xem k·∫øt qu·∫£ ch·∫©n ƒëo√°n.");
    }

    // ü§ñ Ph√¢n t√≠ch ·∫£nh
    async function analyzeImage() {
      resultDiv.innerText = "üîç ƒêang ph√¢n t√≠ch...";
      await tf.nextFrame();
      const prediction = await model.predict(preview);
      prediction.sort((a, b) => b.probability - a.probability);
      const top = prediction[0];
      const name = nameMap[top.className.toUpperCase()] || top.className;
      const conf = (top.probability * 100).toFixed(1);

      resultDiv.innerText = `K·∫øt lu·∫≠n: ${name} (${conf}%)`;
      speak(`K·∫øt lu·∫≠n: ${name}. ƒê·ªô tin c·∫≠y ${conf} ph·∫ßn trƒÉm.`);
      showDetails(name);
    }

    // üìñ Hi·ªÉn th·ªã chi ti·∫øt
    function showDetails(name) {
      const data = diseaseDetails[name];
      if (!data) return;
      symptoms.textContent = data.symptoms;
      causes.textContent = data.causes;
      prevention.textContent = data.prevention;
      care.textContent = data.care;
      treatment.textContent = data.treatment;
      detailsBtn.disabled = false;
      lastClassName = name;
    }

    detailsBtn.onclick = () => {
      if (details.style.display === "block") {
        details.style.display = "none";
      } else if (lastClassName) {
        details.style.display = "block";
        const d = diseaseDetails[lastClassName];
        speak(`Bi·ªÉu hi·ªán: ${d.symptoms}. Nguy√™n nh√¢n: ${d.causes}. Ph√≤ng ng·ª´a: ${d.prevention}. ChƒÉm s√≥c: ${d.care}. ƒêi·ªÅu tr·ªã: ${d.treatment}.`);
      }
    };

    // G√°n s·ª± ki·ªán
    const webcam = document.getElementById('webcam');
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const detailsBtn = document.getElementById('detailsBtn');
    const resultDiv = document.getElementById('result');
    const details = document.getElementById('details');
    const symptoms = document.getElementById('symptoms');
    const causes = document.getElementById('causes');
    const prevention = document.getElementById('prevention');
    const care = document.getElementById('care');
    const treatment = document.getElementById('treatment');

    startBtn.onclick = () => startCamera();
    captureBtn.onclick = () => captureImage();
    analyzeBtn.onclick = () => analyzeImage();

    loadModel();
  </script>
</body>
</html>
