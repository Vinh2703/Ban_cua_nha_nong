<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Nhận diện bệnh trên lá</title>

  <!-- TensorFlow.js và Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      text-align: center;
      padding: 10px;
    }
    h1 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    video, img {
      width: 90%;
      max-width: 360px;
      border-radius: 10px;
      border: 2px solid #81c784;
      margin-top: 10px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #66bb6a;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #1b5e20;
    }
    #details {
      background: #f1f8e9;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      display: none;
      text-align: left;
    }
    #details p {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <h1>🌿 AI Nhận diện bệnh trên lá</h1>

  <!-- Hiển thị camera và ảnh chụp -->
  <video id="webcam" autoplay playsinline></video>
  <img id="preview" style="display:none;">

  <!-- Các nút điều khiển -->
  <div>
    <button id="startBtn">📷 Bật camera</button>
    <button id="switchBtn" disabled>🔄 Đổi camera</button>
    <button id="captureBtn" disabled>📸 Chụp ảnh</button>
    <button id="analyzeBtn" disabled>🤖 Phân tích</button>
    <button id="detailsBtn" disabled>📖 Xem chi tiết</button>
  </div>

  <!-- Kết quả -->
  <div id="result">Chưa có dữ liệu.</div>

  <!-- Thông tin chi tiết bệnh -->
  <div id="details">
    <h3>Chi tiết bệnh:</h3>
    <p><b>Triệu chứng:</b> <span id="symptoms"></span></p>
    <p><b>Nguyên nhân:</b> <span id="causes"></span></p>
    <p><b>Phòng ngừa:</b> <span id="prevention"></span></p>
    <p><b>Chăm sóc:</b> <span id="care"></span></p>
    <p><b>Điều trị:</b> <span id="treatment"></span></p>
  </div>

  <!-- Script chính -->
  <script>
  // ====== CẤU HÌNH & DỮ LIỆU ======
  const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
  let model = null, stream = null, currentDeviceId = null, videoDevices = [];

  const diseaseDetails = {
    "BỆNH ĐỐM NÂU": {
      symptoms: "Xuất hiện các đốm nâu tròn, sau lan rộng làm khô lá.",
      causes: "Nấm Cercospora sp phát triển trong điều kiện ẩm ướt.",
      prevention: "Không tưới quá ẩm, tỉa thưa lá, luân canh cây trồng.",
      care: "Giữ vườn thông thoáng, loại bỏ lá bệnh.",
      treatment: "Phun thuốc gốc đồng hoặc Mancozeb theo hướng dẫn."
    },
    "BỆNH KHÔ LÁ": {
      symptoms: "Lá khô từ mép vào, chuyển vàng, dễ rụng.",
      causes: "Do nấm Alternaria sp gây ra.",
      prevention: "Tránh tưới nước lên lá, kiểm soát độ ẩm.",
      care: "Thu gom lá bệnh tiêu hủy.",
      treatment: "Phun Daconil hoặc Score theo tỷ lệ 1.5ml/lít nước."
    },
    "KHỎE MẠNH": {
      symptoms: "Lá xanh đều, không có vết bệnh.",
      causes: "Điều kiện sinh trưởng tốt.",
      prevention: "Tiếp tục chăm sóc bình thường.",
      care: "Duy trì bón phân và tưới nước hợp lý.",
      treatment: "Không cần xử lý thêm."
    }
  };

  // ====== LIÊN KẾT TỚI PHẦN TỬ HTML ======
  const video = document.getElementById('webcam');
  const preview = document.getElementById('preview');
  const startBtn = document.getElementById('startBtn');
  const switchBtn = document.getElementById('switchBtn');
  const captureBtn = document.getElementById('captureBtn');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const detailsBtn = document.getElementById('detailsBtn');
  const resultDiv = document.getElementById('result');
  const detailsDiv = document.getElementById('details');
  const symptomsEl = document.getElementById('symptoms');
  const causesEl = document.getElementById('causes');
  const preventionEl = document.getElementById('prevention');
  const careEl = document.getElementById('care');
  const treatmentEl = document.getElementById('treatment');

  // ====== GIỌNG NÓI ======
  speechSynthesis.onvoiceschanged = () => {};
  function speak(text){
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'vi-VN';
    const voices = speechSynthesis.getVoices();
    const vn = voices.find(v=>/vi|vietnamese/i.test(v.lang));
    if(vn) utter.voice = vn;
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }

  // ====== TẢI MÔ HÌNH ======
  async function loadModel(){
    resultDiv.innerText = "⏳ Đang tải mô hình...";
    speak("Đang tải mô hình trí tuệ nhân tạo, vui lòng đợi.");
    await tf.ready();
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    resultDiv.innerText = "✅ Mô hình đã sẵn sàng. Nhấn Bật camera.";
    speak("Mô hình đã sẵn sàng. Nhấn Bật camera để bắt đầu.");
  }
  loadModel();

  // ====== CAMERA ======
  async function listVideoDevices(){
    videoDevices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
  }

  async function startCamera(preferBack=true){
    await listVideoDevices();
    let constraints;
    if(videoDevices.length>0){
      let back = videoDevices.find(d=>/back|rear|environment/i.test(d.label));
      if(preferBack && back){
        currentDeviceId = back.deviceId;
        constraints = { video:{deviceId:{exact:currentDeviceId}} };
      } else constraints = { video:{facingMode:"environment"} };
    } else constraints = { video:true };

    if(stream){ stream.getTracks().forEach(t=>t.stop()); }
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();

    captureBtn.disabled=false;
    switchBtn.disabled=videoDevices.length<2;
    startBtn.disabled=true;
    resultDiv.innerText="📸 Camera đã bật. Bạn có thể chụp ảnh.";
    speak("Camera đã bật, bạn có thể chụp ảnh.");
  }

  async function switchCamera(){
    if(videoDevices.length<2) return;
    let idx = videoDevices.findIndex(d=>d.deviceId===currentDeviceId);
    currentDeviceId = videoDevices[(idx+1)%videoDevices.length].deviceId;
    await startCamera(false);
  }

  function captureImage(){
    const canvas=document.createElement('canvas');
    canvas.width=video.videoWidth; canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
    preview.src=canvas.toDataURL('image/jpeg');
    preview.style.display='block';
    analyzeBtn.disabled=false;
    resultDiv.innerText="📷 Ảnh đã chụp, nhấn Phân tích.";
    speak("Ảnh đã chụp, nhấn phân tích để xem kết quả.");
  }

  // ====== PHÂN TÍCH ẢNH ======
  async function analyzeImage(){
    if(!model){
      resultDiv.innerText="⚠️ Mô hình chưa sẵn sàng.";
      speak("Mô hình chưa sẵn sàng, vui lòng đợi.");
      return;
    }
    if(!preview.src){
      resultDiv.innerText="⚠️ Bạn cần chụp ảnh trước khi phân tích.";
      speak("Bạn cần chụp ảnh trước khi phân tích.");
      return;
    }

    resultDiv.innerText="🔍 Đang phân tích...";
    speak("Đang phân tích ảnh.");
    await new Promise(r=>preview.complete?r():preview.onload=r);

    const prediction = await model.predict(preview);
    prediction.sort((a,b)=>b.probability-a.probability);
    const top = prediction[0];
    const className = top.className.toUpperCase();
    const confidence = (top.probability*100).toFixed(1);
    resultDiv.innerText=`Kết luận: ${className}. Độ tin cậy: ${confidence}%`;
    speak(`Kết luận: ${className}. Độ tin cậy ${confidence} phần trăm.`);
    showDetails(className);
  }

  function showDetails(className){
    const data = diseaseDetails[className];
    if(!data){ detailsDiv.style.display='none'; return; }
    symptomsEl.innerText=data.symptoms;
    causesEl.innerText=data.causes;
    preventionEl.innerText=data.prevention;
    careEl.innerText=data.care;
    treatmentEl.innerText=data.treatment;
    detailsDiv.style.display='block';
    detailsBtn.disabled=false;
    speak(`Chi tiết bệnh ${className}. ${data.symptoms}`);
  }

  // ====== SỰ KIỆN ======
  startBtn.onclick = ()=>startCamera();
  switchBtn.onclick = ()=>switchCamera();
  captureBtn.onclick = ()=>captureImage();
  analyzeBtn.onclick = ()=>analyzeImage();
  detailsBtn.onclick = ()=>{ detailsDiv.style.display = detailsDiv.style.display==='block'?'none':'block'; };
  </script>
</body>
</html>
