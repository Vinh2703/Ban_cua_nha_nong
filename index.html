<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B·∫°n c·ªßa nh√† n√¥ng üåæ</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f3fffb; margin:0; padding:18px; text-align:center; }
    h1 { margin:0 0 10px; color:#0b6b4f; }
    p { margin:6px 0 12px; color:#2e2e2e; }
    #videoWrap, #previewWrap { display:flex; justify-content:center; }
    video, img { width:92%; max-width:360px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    #controls { margin-top:12px; }
    button {
      margin:6px; padding:12px 16px; font-size:16px; border-radius:10px; border:none; color:white;
      background:#007b66; cursor:pointer;
    }
    button[disabled] { background:#9fcac2; cursor:not-allowed; }
    #result { margin-top:14px; font-size:18px; color:#0b5a46; font-weight:700; min-height:48px; }
    small { display:block; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <h1>üåæ B·∫°n c·ªßa nh√† n√¥ng</h1>
  <p>Ch·ª•p l√° c√¢y ‚Äî Ph√¢n t√≠ch b·∫±ng AI ‚Äî K·∫øt qu·∫£ s·∫Ω ƒë·ªçc b·∫±ng gi·ªçng n·ªØ</p>

  <div id="videoWrap">
    <video id="webcam" autoplay playsinline muted></video>
  </div>

  <div id="previewWrap" style="margin-top:10px;">
    <img id="preview" alt="·∫¢nh ch·ª•p s·∫Ω hi·ªán ·ªü ƒë√¢y" style="display:none" />
  </div>

  <div id="controls">
    <button id="startBtn">üì∑ B·∫≠t camera sau</button>
    <button id="switchBtn" disabled>üîÑ Chuy·ªÉn camera</button>
    <button id="captureBtn" disabled>üì∏ Ch·ª•p ·∫£nh</button>
    <button id="analyzeBtn" disabled>üß† Ph√¢n t√≠ch</button>
  </div>

  <div id="result">K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</div>
  <small>L∆∞u √Ω: M·ªü b·∫±ng Chrome ch√≠nh ch·ªß, cho ph√©p quy·ªÅn Camera khi ƒë∆∞·ª£c h·ªèi.</small>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";

    const video = document.getElementById('webcam');
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const switchBtn = document.getElementById('switchBtn');
    const captureBtn = document.getElementById('captureBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultDiv = document.getElementById('result');

    let model = null;
    let stream = null;
    let currentDeviceId = null;
    let videoDevices = [];

    // Load model
    async function loadModel() {
      try {
        resultDiv.innerText = "ƒêang t·∫£i m√¥ h√¨nh...";
        model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        resultDiv.innerText = "‚úÖ M√¥ h√¨nh s·∫µn s√†ng. Nh·∫•n 'B·∫≠t camera sau'.";
        speak("M√¥ h√¨nh ƒë√£ s·∫µn s√†ng. Nh·∫•n b·∫≠t camera ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
      } catch (e) {
        console.error(e);
        resultDiv.innerText = "‚ùå Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh: " + e;
        speak("Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh, vui l√≤ng ki·ªÉm tra m·∫°ng.");
      }
    }

    async function listVideoDevices() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        videoDevices = devices.filter(d => d.kind === 'videoinput');
      } catch (e) {
        console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c thi·∫øt b·ªã: ", e);
      }
    }

    async function checkCameraPermission() {
      try {
        const status = await navigator.permissions.query({ name: 'camera' });
        if(status.state === 'denied') {
          alert('B·∫°n ch∆∞a c·∫•p quy·ªÅn camera. Vui l√≤ng b·∫≠t quy·ªÅn camera trong C√†i ƒë·∫∑t c·ªßa tr√¨nh duy·ªát.');
          return false;
        }
        return true;
      } catch(e) {
        return true; // n·∫øu tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Permissions API
      }
    }

    async function startCamera(preferEnvironment = true) {
      if(!(await checkCameraPermission())) return;

      try {
        await listVideoDevices();
        let constraints;
        if (videoDevices.length > 0) {
          let back = videoDevices.find(d => /back|rear|environment|primary/i.test(d.label));
          if(preferEnvironment && back) {
            currentDeviceId = back.deviceId;
            constraints = { video: { deviceId: { exact: currentDeviceId } } };
          } else if(preferEnvironment) {
            constraints = { video: { facingMode: "environment" } };
          } else {
            constraints = { video: { facingMode: "user" } };
          }
        } else {
          constraints = { video: { facingMode: "environment" } };
        }

        stopCamera();
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();

        captureBtn.disabled = false;
        switchBtn.disabled = videoDevices.length < 2;
        startBtn.disabled = true;
        resultDiv.innerText = "üì∏ Camera ƒë√£ b·∫≠t. B·∫°n c√≥ th·ªÉ ch·ª•p ·∫£nh.";
        speak("Camera ƒë√£ b·∫≠t, b·∫°n c√≥ th·ªÉ ch·ª•p ·∫£nh.");
      } catch(err) {
        console.error("Kh√¥ng m·ªü ƒë∆∞·ª£c camera:", err);
        resultDiv.innerText = "‚ùå L·ªói m·ªü camera: " + (err.message || err);
        speak("Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p camera v√† HTTPS.");
      }
    }

    function stopCamera() {
      if(stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      captureBtn.disabled = true;
      analyzeBtn.disabled = true;
      switchBtn.disabled = true;
      startBtn.disabled = false;
    }

    async function switchCamera() {
      if(!videoDevices || videoDevices.length < 2) return;
      let ids = videoDevices.map(d => d.deviceId);
      let idx = ids.indexOf(currentDeviceId);
      let next = (idx + 1) % ids.length;
      currentDeviceId = ids[next];
      await startCamera(false);
    }

    function captureImage() {
      if(!video || video.readyState < 2) {
        resultDiv.innerText = "‚ö†Ô∏è Video ch∆∞a s·∫µn s√†ng ƒë·ªÉ ch·ª•p.";
        speak("Video ch∆∞a s·∫µn s√†ng, th·ª≠ l·∫°i.");
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      preview.src = canvas.toDataURL('image/jpeg');
      preview.style.display = 'block';
      analyzeBtn.disabled = false;
      resultDiv.innerText = "üì∑ ·∫¢nh ƒë√£ ƒë∆∞·ª£c ch·ª•p. B·∫°n c√≥ th·ªÉ ph√¢n t√≠ch.";
      speak("·∫¢nh ƒë√£ ƒë∆∞·ª£c ch·ª•p. Nh·∫•n ph√¢n t√≠ch ƒë·ªÉ xem k·∫øt qu·∫£.");
    }

    async function analyzeImage() {
      if(!model) {
        resultDiv.innerText = "‚ö†Ô∏è M√¥ h√¨nh ch∆∞a s·∫µn s√†ng.";
        speak("M√¥ h√¨nh ch∆∞a s·∫µn s√†ng, vui l√≤ng ƒë·ª£i.");
        return;
      }
      if(!preview.src) {
        resultDiv.innerText = "‚ö†Ô∏è Ch∆∞a c√≥ ·∫£nh ƒë·ªÉ ph√¢n t√≠ch.";
        speak("B·∫°n ch∆∞a ch·ª•p ·∫£nh, h√£y ch·ª•p tr∆∞·ªõc khi ph√¢n t√≠ch.");
        return;
      }

      resultDiv.innerText = "ƒêang ph√¢n t√≠ch...";
      try {
        await ensureImageLoaded(preview);
        const prediction = await model.predict(preview);
        prediction.sort((a,b) => b.probability - a.probability);
        const top = prediction[0];
        const text = `K·∫øt lu·∫≠n: ${top.className}. ƒê·ªô tin c·∫≠y ${(top.probability*100).toFixed(1)} ph·∫ßn trƒÉm.`;
        resultDiv.innerText = text;
        speak(text);
      } catch(e) {
        console.error("L·ªói ph√¢n t√≠ch:", e);
        resultDiv.innerText = "‚ùå L·ªói ph√¢n t√≠ch: " + e;
        speak("L·ªói khi ph√¢n t√≠ch, th·ª≠ l·∫°i.");
      }
    }

    function ensureImageLoaded(imgEl) {
      return new Promise((resolve, reject) => {
        if(!imgEl.src) return reject("No image source");
        if(imgEl.complete && imgEl.naturalWidth !== 0) return resolve();
        imgEl.onload = () => resolve();
        imgEl.onerror = e => reject(e);
      });
    }

    function speak(text) {
      try {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'vi-VN';
        const voices = speechSynthesis.getVoices();
        if(voices && voices.length>0){
          const vnFemale = voices.find(v => /vi|vietnamese/i.test(v.lang) && /female|woman/i.test(v.name.toLowerCase()))
                           || voices.find(v => /vi|vietnamese/i.test(v.lang));
          if(vnFemale) utter.voice = vnFemale;
        }
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch(e) { console.warn("Speech error:", e); }
    }

    // S·ª± ki·ªán
    startBtn.addEventListener('click', () => startCamera(true));
    switchBtn.addEventListener('click', switchCamera);
    captureBtn.addEventListener('click', captureImage);
    analyzeBtn.addEventListener('click', analyzeImage);
    window.addEventListener('beforeunload', stopCamera);

    // Load model khi trang load
    loadModel();
  </script>
</body>
</html>
