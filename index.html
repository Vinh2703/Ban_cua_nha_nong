<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ứng dụng AI Bạn của nhà nông</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#f1f8e9,#c8e6c9);padding:14px;text-align:center}
  h1{color:#1b5e20;margin:6px 0 10px;font-size:22px}
  video,img{width:94%;max-width:420px;border-radius:12px;border:3px solid #4caf50;margin:8px auto;display:block}
  button{display:block;margin:8px auto;padding:12px 18px;font-size:18px;border-radius:10px;border:none;background:#43a047;color:#fff;cursor:pointer;width:90%;max-width:420px}
  button.secondary{background:#fff;color:#2e7d32;border:2px solid #4caf50}
  button:disabled{background:#ccc;color:#666;cursor:not-allowed}
  #result{margin-top:12px;font-size:18px;font-weight:700;color:#1b5e20}
  #details{display:none;background:#fff;margin:14px auto;padding:12px;border-radius:10px;max-width:420px;text-align:left;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  #details h3{color:#2e7d32;margin-bottom:8px;text-align:center}
  #details p{margin:6px 0;font-size:16px;color:#2e2e2e}
</style>
</head>
<body>
  <h1>🌾 Ứng dụng AI Bạn của nhà nông</h1>

  <video id="webcam" autoplay playsinline muted></video>
  <img id="preview" style="display:none">

  <button id="startBtn">📷 Bật camera</button>
  <button id="switchBtn" class="secondary" disabled>🔄 Đổi camera</button>
  <button id="captureBtn" disabled>🖼️ Chụp ảnh</button>
  <button id="analyzeBtn" disabled>🤖 Phân tích bệnh</button>
  <button id="detailsBtn" disabled>📖 Xem chi tiết</button>
  <button id="speakBtn" disabled>🔊 Nghe lại thông tin bệnh</button>

  <div id="result">Chưa có dữ liệu.</div>

  <div id="details">
    <h3>📘 Thông tin chi tiết</h3>
    <p><b>Biểu hiện:</b> <span id="symptoms"></span></p>
    <p><b>Nguyên nhân:</b> <span id="causes"></span></p>
    <p><b>Phòng ngừa:</b> <span id="prevention"></span></p>
    <p><b>Chăm sóc:</b> <span id="care"></span></p>
    <p><b>Điều trị:</b> <span id="treatment"></span></p>
  </div>

<script>
/* ====== Cấu hình ====== */
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
let model=null, stream=null, devices=[], currentDeviceId=null, lastClassName=null, ttsUnlocked=false;

/* ====== Map + dữ liệu bệnh (giữ ngắn gọn) ====== */
const nameMap = {
  "BENH_KHO_VAN":"Bệnh khô vằn",
  "BENH_DOM_LA_LON":"Bệnh đốm lá lớn",
  "BENH_PHAN_DEN":"Bệnh phấn đen",
  "CAY_NGO_KHOE":"Cây ngô khỏe"
};
const diseaseDetails = {
  "Bệnh khô vằn": {
    symptoms: "Vết loang xám tro trên bẹ lá và thân; lan từ gốc lên bắp, làm lá vàng khô.",
    causes: "Nấm Rhizoctonia solani; ẩm độ cao, 25–30°C.",
    prevention: "Chọn giống ít nhiễm, vệ sinh đồng ruộng, luân canh.",
    care: "Giữ ruộng thông thoáng, hạn chế đạm.",
    treatment: "Phun thuốc khuyến cáo (Anvil, Tilt...)."
  },
  "Bệnh đốm lá lớn": {
    symptoms: "Đốm bầu dục dài, giữa xám tro; nặng làm lá khô.",
    causes: "Nấm Exserohilum turcicum; khí hậu nóng ẩm.",
    prevention: "Luân canh, dọn tàn dư, giống kháng.",
    care: "Giảm đạm, tăng kali, chế phẩm sinh học.",
    treatment: "Phun Daconil/Score/Tilt."
  },
  "Bệnh phấn đen": {
    symptoms: "U sưng trắng trên bẹ/trái, bên trong là bột đen (bào tử).",
    causes: "Nấm Ustilago; lây qua gió/nước/vết thương.",
    prevention: "Xử lý hạt giống, luân canh, dọn tàn dư.",
    care: "Cắt bỏ phần bệnh, tăng kali và hữu cơ.",
    treatment: "Phun thuốc chứa tebuconazole, propiconazole..."
  },
  "Cây ngô khỏe": {
    symptoms: "Lá xanh bóng, không vết bệnh.",
    causes: "Điều kiện sinh trưởng tốt.",
    prevention: "Duy trì tưới bón cân bằng.",
    care: "Giữ thông thoáng, phòng bệnh định kỳ.",
    treatment: "Không cần xử lý."
  }
};

/* ====== Elements ====== */
const videoEl = document.getElementById('webcam');
const previewEl = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const detailsBtn = document.getElementById('detailsBtn');
const speakBtn = document.getElementById('speakBtn');
const resultDiv = document.getElementById('result');
const detailsDiv = document.getElementById('details');
const symptomsEl = document.getElementById('symptoms');
const causesEl = document.getElementById('causes');
const preventionEl = document.getElementById('prevention');
const careEl = document.getElementById('care');
const treatmentEl = document.getElementById('treatment');

/* ====== TTS helper & unlock ====== */
function speak(text) {
  try {
    if (!('speechSynthesis' in window)) return;
    // if not unlocked, attempt to unlock in user gesture
    if (!ttsUnlocked) {
      ttsUnlocked = true;
      const u0 = new SpeechSynthesisUtterance('Ứng dụng sẵn sàng đọc bằng tiếng Việt.');
      u0.lang = 'vi-VN';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u0);
      setTimeout(() => {
        const u1 = new SpeechSynthesisUtterance(text);
        u1.lang = 'vi-VN';
        u1.rate = 0.95;
        window.speechSynthesis.speak(u1);
      }, 350);
      return;
    }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'vi-VN';
    u.rate = 0.95;
    window.speechSynthesis.speak(u);
  } catch (e) { console.warn('TTS error', e); }
}

/* ====== Normalize & fuzzy find ====== */
function normalizeLabel(s){
  if(!s) return '';
  return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Za-z0-9\s_-]/g,'').trim().toUpperCase().replace(/\s+/g,'_');
}
function findClosestName(label){
  if(!label) return null;
  const n = normalizeLabel(label);
  // check nameMap keys
  for(const k in nameMap) if(n === k || n.includes(k) || k.includes(n)) return nameMap[k];
  // check diseaseDetails keys
  for(const k in diseaseDetails) {
    if(normalizeLabel(k) === n || normalizeLabel(k).includes(n) || n.includes(normalizeLabel(k))) return k;
  }
  return null;
}

/* ====== Load model ====== */
async function loadModel(){
  resultDiv.innerText = '⏳ Đang tải mô hình...';
  await tf.ready();
  model = await tmImage.load(MODEL_URL+'model.json', MODEL_URL+'metadata.json');
  resultDiv.innerText = '✅ Mô hình sẵn sàng. Nhấn Bật camera.';
}
loadModel();

/* ====== Devices & camera ====== */
async function enumDevices(){
  try {
    const all = await navigator.mediaDevices.enumerateDevices();
    devices = all.filter(d => d.kind === 'videoinput');
    switchBtn.disabled = devices.length < 2;
  } catch(e) { devices = []; switchBtn.disabled = true; }
}

async function startCamera(preferBack=true){
  try {
    await enumDevices();
    let constraints = { video: { facingMode: { ideal: 'environment' } } };
    const back = devices.find(d => /back|rear|environment/i.test(d.label));
    if(preferBack && back) constraints = { video: { deviceId: { exact: back.deviceId } } };
    if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = stream;
    await new Promise(r => {
      const check = () => { if(videoEl.videoWidth && videoEl.videoHeight) r(); else requestAnimationFrame(check); };
      check();
    });
    captureBtn.disabled = false;
    analyzeBtn.disabled = true;
    detailsBtn.disabled = true;
    speakBtn.disabled = true;
    startBtn.disabled = true;
    resultDiv.innerText = '📸 Camera đã bật. Hãy chụp ảnh.';
    speak('Camera đã bật. Hãy chụp ảnh.');
    await enumDevices();
  } catch(e) {
    console.error(e);
    alert('Không thể bật camera. Mở Chrome và cấp quyền camera.');
    resultDiv.innerText = '❌ Không thể bật camera';
  }
}
async function switchCamera(){
  if(devices.length < 2) return;
  const idx = devices.findIndex(d => d.deviceId === currentDeviceId);
  const next = devices[(idx + 1) % devices.length] || devices[0];
  currentDeviceId = next.deviceId;
  await startCamera(false);
}

/* ====== Capture ====== */
async function captureImage(){
  if(!stream){ alert('Chưa bật camera.'); return; }
  if(!videoEl.videoWidth || !videoEl.videoHeight){
    await new Promise(res => {
      const check = () => { if(videoEl.videoWidth && videoEl.videoHeight) res(); else requestAnimationFrame(check); };
      check();
    });
  }
  const c = document.createElement('canvas');
  c.width = videoEl.videoWidth; c.height = videoEl.videoHeight;
  c.getContext('2d').drawImage(videoEl,0,0,c.width,c.height);
  previewEl.src = c.toDataURL('image/jpeg', 0.92);
  previewEl.style.display = 'block';
  analyzeBtn.disabled = false;
  detailsBtn.disabled = true;
  speakBtn.disabled = true;
  resultDiv.innerText = '🖼️ Ảnh đã chụp.';
  speak('Ảnh đã chụp. Nhấn phân tích.');
}

/* ====== Analyze ====== */
async function analyzeImage(){
  if(!model){ alert('Mô hình chưa sẵn sàng.'); return; }
  if(!previewEl.src){ alert('Bạn cần chụp ảnh trước.'); return; }
  resultDiv.innerText = '🔍 Đang phân tích...';
  await new Promise(r => previewEl.complete ? r() : previewEl.onload = r);
  try {
    const preds = await model.predict(previewEl);
    preds.sort((a,b)=>b.probability-a.probability);
    const top = preds[0];
    const raw = String(top.className || '');
    const name = findClosestName(raw) || raw.trim() || 'Không xác định';
    const conf = (top.probability*100).toFixed(1);
    resultDiv.innerText = `Kết luận: ${name} (${conf}%)`;
    speak(`Kết luận: ${name}. Độ tin cậy ${conf} phần trăm.`);
    lastClassName = name;
    showDetails(name);
    detailsBtn.disabled = false;
    speakBtn.disabled = false;
  } catch(e){
    console.error(e);
    resultDiv.innerText = '❌ Lỗi khi phân tích';
    speak('Lỗi khi phân tích. Vui lòng thử lại.');
  }
}

/* ====== Show details & speak details ====== */
function showDetails(name){
  let info = diseaseDetails[name];
  if(!info){
    const fb = findClosestName(name);
    if(fb) info = diseaseDetails[fb];
  }
  if(!info){
    symptomsEl.textContent=''; causesEl.textContent=''; preventionEl.textContent=''; careEl.textContent=''; treatmentEl.textContent='';
    return false;
  }
  symptomsEl.textContent = info.symptoms;
  causesEl.textContent = info.causes;
  preventionEl.textContent = info.prevention;
  careEl.textContent = info.care;
  treatmentEl.textContent = info.treatment;
  return true;
}

detailsBtn.addEventListener('click', ()=>{
  if(!lastClassName){ alert('Bạn chưa phân tích ảnh.'); return; }
  const ok = showDetails(lastClassName);
  if(!ok){ alert('Chưa có thông tin chi tiết cho kết quả này.'); return; }
  detailsDiv.style.display = detailsDiv.style.display === 'block' ? 'none' : 'block';
  if(detailsDiv.style.display === 'block'){
    const d = diseaseDetails[lastClassName] || diseaseDetails[findClosestName(lastClassName)];
    if(d) speak(`Biểu hiện: ${d.symptoms}. Nguyên nhân: ${d.causes}. Phòng ngừa: ${d.prevention}. Chăm sóc: ${d.care}. Điều trị: ${d.treatment}.`);
  }
});

speakBtn.addEventListener('click', ()=>{
  if(!lastClassName){ alert('Chưa có kết quả phân tích.'); return; }
  const d = diseaseDetails[lastClassName] || diseaseDetails[findClosestName(lastClassName)];
  if(!d){ alert('Không có thông tin chi tiết.'); return; }
  speak(`Biểu hiện: ${d.symptoms}. Nguyên nhân: ${d.causes}. Phòng ngừa: ${d.prevention}. Chăm sóc: ${d.care}. Điều trị: ${d.treatment}.`);
});

/* ====== Events ====== */
startBtn.addEventListener('click', ()=>startCamera());
switchBtn.addEventListener('click', ()=>switchCamera());
captureBtn.addEventListener('click', ()=>captureImage());
analyzeBtn.addEventListener('click', ()=>analyzeImage());

/* ====== Init ====== */
(function init(){
  captureBtn.disabled=true; analyzeBtn.disabled=true; detailsBtn.disabled=true; speakBtn.disabled=true;
  enumDevices();
})();
</script>
</body>
</html>
