<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Báº¡n cá»§a nhÃ  nÃ´ng ğŸŒ¾</title>
<style>
body { font-family: Arial, sans-serif; background:#f3fffb; margin:0; padding:18px; text-align:center; }
h1 { margin:0 0 10px; color:#0b6b4f; }
p { margin:6px 0 12px; color:#2e2e2e; }
#videoWrap, #previewWrap { display:flex; justify-content:center; }
video, img { width:92%; max-width:360px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
#controls { margin-top:12px; }
button { margin:6px; padding:12px 16px; font-size:16px; border-radius:10px; border:none; color:white; background:#007b66; cursor:pointer; }
button[disabled] { background:#9fcac2; cursor:not-allowed; }
#result { margin-top:14px; font-size:18px; color:#0b5a46; font-weight:700; min-height:48px; }
#details { margin-top:12px; text-align:left; display:none; background:#e8f6f2; padding:12px; border-radius:10px; }
#details p { margin:4px 0; }
small { display:block; color:#666; margin-top:8px; }
</style>
</head>
<body>
<h1>ğŸŒ¾ Báº¡n cá»§a nhÃ  nÃ´ng</h1>
<p>Chá»¥p lÃ¡ cÃ¢y â€” PhÃ¢n tÃ­ch báº±ng AI â€” Káº¿t quáº£ sáº½ Ä‘á»c báº±ng giá»ng ná»¯</p>

<div id="videoWrap"><video id="webcam" autoplay playsinline muted></video></div>
<div id="previewWrap" style="margin-top:10px;"><img id="preview" alt="áº¢nh chá»¥p sáº½ hiá»‡n á»Ÿ Ä‘Ã¢y" style="display:none"></div>

<div id="controls">
  <button id="startBtn">ğŸ“· Báº­t camera sau</button>
  <button id="switchBtn" disabled>ğŸ”„ Chuyá»ƒn camera</button>
  <button id="captureBtn" disabled>ğŸ“¸ Chá»¥p áº£nh</button>
  <button id="analyzeBtn" disabled>ğŸ§  PhÃ¢n tÃ­ch</button>
  <button id="detailsBtn" disabled>ğŸ“– Xem chi tiáº¿t</button>
</div>

<div id="result">Káº¿t quáº£ sáº½ hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y...</div>

<div id="details">
  <p><strong>Biá»ƒu hiá»‡n:</strong> <span id="symptoms"></span></p>
  <p><strong>NguyÃªn nhÃ¢n:</strong> <span id="causes"></span></p>
  <p><strong>CÃ¡ch phÃ²ng:</strong> <span id="prevention"></span></p>
  <p><strong>ChÄƒm sÃ³c:</strong> <span id="care"></span></p>
  <p><strong>Äiá»u trá»‹:</strong> <span id="treatment"></span></p>
</div>

<small>LÆ°u Ã½: Má»Ÿ báº±ng Chrome chÃ­nh chá»§, cho phÃ©p quyá»n Camera khi Ä‘Æ°á»£c há»i.</small>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";

const video = document.getElementById('webcam');
const preview = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const detailsBtn = document.getElementById('detailsBtn');
const resultDiv = document.getElementById('result');
const symptomsEl = document.getElementById('symptoms');
const causesEl = document.getElementById('causes');
const preventionEl = document.getElementById('prevention');
const careEl = document.getElementById('care');
const treatmentEl = document.getElementById('treatment');
const detailsDiv = document.getElementById('details');

let model = null;
let stream = null;
let currentDeviceId = null;
let videoDevices = [];

const diseaseDetails = {
  "Bá»†NH KHÃ” VÃ‚N": {
    symptoms:"Xuáº¥t hiá»‡n váº¿t bá»‡nh mÃ u xÃ¡m tro, loang lá»• nhÆ° váº±n da há»• trÃªn phiáº¿n lÃ¡, báº¹ lÃ¡, thÃ¢n vÃ  cáº£ báº¯p ngÃ´. Váº¿t bá»‡nh lan tá»« gá»‘c lÃªn tá»›i báº¯p, lÃ m lÃ¡ vÃ ng Ãºa, khÃ´ hÃ©o, cÃ¢y tÃ n lá»¥i nhanh. Khi bá»‡nh náº·ng, giáº£m nÄƒng suáº¥t tá»« 20â€“70%.",
    causes:"Do náº¥m Rhizoctonia solani Kuhn gÃ¢y ra. Náº¥m phÃ¡t triá»ƒn máº¡nh trong Ä‘iá»u kiá»‡n áº©m Æ°á»›t, nhiá»‡t Ä‘á»™ cao, Ä‘áº¥t thoÃ¡t nÆ°á»›c kÃ©m, máº­t Ä‘á»™ gieo trá»“ng dÃ y. Bá»‡nh xuáº¥t hiá»‡n á»Ÿ nhiá»u giai Ä‘oáº¡n sinh trÆ°á»Ÿng cá»§a cÃ¢y ngÃ´.",
    prevention:"LuÃ¢n canh cÃ¢y trá»“ng; giá»¯ khoáº£ng cÃ¡ch gieo trá»“ng há»£p lÃ½ Ä‘á»ƒ thÃ´ng thoÃ¡ng; dá»n sáº¡ch tÃ n dÆ° thá»±c váº­t sau thu hoáº¡ch; bÃ³n phÃ¢n cÃ¢n Ä‘á»‘i (tÄƒng kali, háº¡n cháº¿ Ä‘áº¡m quÃ¡ má»©c).",
    care:"Theo dÃµi cÃ¢y, loáº¡i bá» lÃ¡ bá»‡nh; giá»¯ Ä‘áº¥t vÃ  khÃ´ng gian xung quanh thÃ´ng thoÃ¡ng; duy trÃ¬ cháº¿ Ä‘á»™ bÃ³n phÃ¢n há»£p lÃ½.",
    treatment:"Sá»­ dá»¥ng thuá»‘c trá»« náº¥m: Validamycin, Hexaconazole, Propiconazole. Phun thuá»‘c khi bá»‡nh má»›i xuáº¥t hiá»‡n Ä‘á»ƒ hiá»‡u quáº£ cao. Káº¿t há»£p biá»‡n phÃ¡p sinh há»c nhÆ° cháº¿ pháº©m vi sinh khÃ¡ng náº¥m."
  },
  "Bá»†NH Äá»M LÃ Lá»šN": {
    symptoms:"Xuáº¥t hiá»‡n Ä‘áº§u tiÃªn á»Ÿ lÃ¡ giÃ , sau Ä‘Ã³ lan lÃªn cÃ¡c lÃ¡ phÃ­a trÃªn. TrÃªn lÃ¡ cÃ³ váº¿t Ä‘á»‘m hÃ¬nh thoi hoáº·c khÃ´ng Ä‘á»u, mÃ u nÃ¢u hoáº·c xÃ¡m, viá»n nÃ¢u Ä‘á». Khi bá»‡nh náº·ng, váº¿t Ä‘á»‘m liÃªn káº¿t, lan ra toÃ n bá»™ lÃ¡, lÃ m lÃ¡ khÃ´ vÃ  rÃ¡ch pháº§n chÃ³t. GÃ¢y háº¡i máº¡nh nháº¥t khi cÃ¢y cÃ³ 7â€“8 lÃ¡ trá»Ÿ lÃªn.",
    causes:"Do náº¥m Exserohilum turcicum (trÆ°á»›c Ä‘Ã¢y Helminthosporium turcicum). Náº¥m phÃ¡t triá»ƒn máº¡nh á»Ÿ nhiá»‡t Ä‘á»™ 28â€“30Â°C, Ä‘á»™ áº©m cao >80%, Ä‘áº¥t nghÃ¨o dinh dÆ°á»¡ng, chÄƒm sÃ³c kÃ©m.",
    prevention:"LuÃ¢n canh cÃ¢y trá»“ng Ä‘á»ƒ trÃ¡nh tÃ­ch tá»¥ nguá»“n bá»‡nh; tÄƒng cÆ°á»ng bÃ³n phÃ¢n há»¯u cÆ¡ vÃ  kali, háº¡n cháº¿ Ä‘áº¡m quÃ¡ má»©c; giá»¯ khoáº£ng cÃ¡ch trá»“ng há»£p lÃ½, ruá»™ng thÃ´ng thoÃ¡ng.",
    care:"Theo dÃµi lÃ¡ giÃ , loáº¡i bá» lÃ¡ bá»‡nh; duy trÃ¬ dinh dÆ°á»¡ng cÃ¢n Ä‘á»‘i; thÃ´ng thoÃ¡ng ruá»™ng vÆ°á»n.",
    treatment:"Sá»­ dá»¥ng cháº¿ pháº©m vi sinh Trichoderma spp.; phun thuá»‘c khi bá»‡nh má»›i xuáº¥t hiá»‡n: Propiconazole, Azoxystrobin, Tebuconazole. LuÃ¢n phiÃªn thuá»‘c Ä‘á»ƒ trÃ¡nh khÃ¡ng thuá»‘c."
  },
  "Bá»†NH PHáº¤N ÄEN": {
    symptoms:"Xuáº¥t hiá»‡n á»Ÿ báº¹ lÃ¡, thÃ¢n, bÃ´ng cá» vÃ  báº¯p ngÃ´. Váº¿t bá»‡nh ban Ä‘áº§u lÃ  ná»‘t u sÆ°ng mÃ u tráº¯ng, nháºµn, sau Ä‘Ã³ phÃ¬nh to vÃ  biáº¿n dáº¡ng. BÃªn trong váº¿t u lÃ  khá»‘i ráº¯n mÃ u vÃ ng tráº¯ng, sau Ä‘Ã³ chuyá»ƒn thÃ nh bá»™t Ä‘en. Khi bÃ³p váº¿t bá»‡nh, khá»‘i bá»™t Ä‘en dá»… vá»¡, gÃ¢y thá»‘i há»ng, nhÄƒn nhÃºm vÃ  dá»‹ dáº¡ng.",
    causes:"Do náº¥m Ustilago maydis hoáº·c Ustilago zeae. Náº¥m tá»“n táº¡i trÃªn háº¡t giá»‘ng, tÃ n dÆ° cÃ¢y bá»‡nh, phÃ¡t tÃ¡n qua giÃ³, nÆ°á»›c tÆ°á»›i, xÃ¢m nháº­p qua váº¿t thÆ°Æ¡ng cÆ¡ giá»›i. PhÃ¡t triá»ƒn máº¡nh khi máº­t Ä‘á»™ trá»“ng dÃ y, bÃ³n dÆ° phÃ¢n Ä‘áº¡m, thá»i tiáº¿t mÆ°a giÃ³, Ä‘á»™ áº©m cao.",
    prevention:"LuÃ¢n canh cÃ¢y trá»“ng, trÃ¡nh trá»“ng ngÃ´ liÃªn tá»¥c trÃªn cÃ¹ng diá»‡n tÃ­ch; xá»­ lÃ½ háº¡t giá»‘ng trÆ°á»›c khi gieo báº±ng thuá»‘c náº¥m; dá»n sáº¡ch tÃ n dÆ° cÃ¢y bá»‡nh; bÃ³n phÃ¢n cÃ¢n Ä‘á»‘i, háº¡n cháº¿ Ä‘áº¡m, tÄƒng kali vÃ  há»¯u cÆ¡.",
    care:"Kiá»ƒm tra ruá»™ng thÆ°á»ng xuyÃªn, phÃ¡t hiá»‡n sá»›m Ä‘á»ƒ xá»­ lÃ½ ká»‹p thá»i; duy trÃ¬ thÃ´ng thoÃ¡ng ruá»™ng vÆ°á»n vÃ  cháº¿ Ä‘á»™ dinh dÆ°á»¡ng há»£p lÃ½.",
    treatment:"Sá»­ dá»¥ng thuá»‘c Ä‘áº·c trá»‹: Antafungal (cháº¿ pháº©m sinh há»c an toÃ n), thuá»‘c chá»©a tebuconazole, propiconazole hoáº·c hexaconazole. Káº¿t há»£p cháº¿ pháº©m vi sinh Trichoderma Ä‘á»ƒ tÄƒng hiá»‡u quáº£ phÃ²ng trá»«."
  }
};

// HÃ m giá»ng nÃ³i
function speak(text){
  const utter=new SpeechSynthesisUtterance(text);
  utter.lang='vi-VN';
  const voices=speechSynthesis.getVoices();
  const vnFemale=voices.find(v=>/vi|vietnamese/i.test(v.lang)&&/female|woman/i.test(v.name.toLowerCase()))||voices.find(v=>/vi|vietnamese/i.test(v.lang));
  if(vnFemale) utter.voice=vnFemale;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

// Load model
async function loadModel(){
  resultDiv.innerText="Äang táº£i mÃ´ hÃ¬nh...";
  speak("Äang táº£i mÃ´ hÃ¬nh AI, vui lÃ²ng Ä‘á»£i.");
  model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
  resultDiv.innerText="âœ… MÃ´ hÃ¬nh sáºµn sÃ ng. Nháº¥n Báº­t camera.";
  speak("MÃ´ hÃ¬nh Ä‘Ã£ sáºµn sÃ ng. Nháº¥n Báº­t camera Ä‘á»ƒ báº¯t Ä‘áº§u.");
}
loadModel();

// Camera
async function listVideoDevices(){ videoDevices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput'); }
async function startCamera(preferBack=true){
  await listVideoDevices();
  let constraints;
  if(videoDevices.length>0){
    let back = videoDevices.find(d=>/back|rear|environment|primary/i.test(d.label));
    if(preferBack && back){ currentDeviceId=back.deviceId; constraints={video:{deviceId:{exact:currentDeviceId}}}; }
    else constraints={video:{facingMode:preferBack?"environment":"user"}};
  } else constraints={video:{facingMode:"environment"}};
  if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
  stream = await navigator.mediaDevices.getUserMedia(constraints);
  video.srcObject=stream;
  await video.play();
  captureBtn.disabled=false; switchBtn.disabled=videoDevices.length<2; startBtn.disabled=true;
  resultDiv.innerText="ğŸ“¸ Camera Ä‘Ã£ báº­t. Báº¡n cÃ³ thá»ƒ chá»¥p áº£nh."; speak("Camera Ä‘Ã£ báº­t, báº¡n cÃ³ thá»ƒ chá»¥p áº£nh.");
}
async function switchCamera(){ if(videoDevices.length<2) return; let idx=videoDevices.findIndex(d=>d.deviceId===currentDeviceId); currentDeviceId=videoDevices[(idx+1)%videoDevices.length].deviceId; await startCamera(false);}
function captureImage(){
  const canvas=document.createElement('canvas');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  preview.src=canvas.toDataURL('image/jpeg'); preview.style.display='block';
  analyzeBtn.disabled=false; resultDiv.innerText="ğŸ“· áº¢nh Ä‘Ã£ chá»¥p, nháº¥n phÃ¢n tÃ­ch."; speak("áº¢nh Ä‘Ã£ chá»¥p, nháº¥n phÃ¢n tÃ­ch Ä‘á»ƒ xem káº¿t quáº£.");
}
async function analyzeImage(){
  if(!model||!preview.src) return;
  resultDiv.innerText="Äang phÃ¢n tÃ­ch..."; speak("Äang phÃ¢n tÃ­ch áº£nh.");
  await new Promise(r=>preview.complete?r():preview.onload=r);
  const prediction = await model.predict(preview);
  prediction.sort((a,b)=>b.probability-a.probability);
  const top=prediction[0];
  const className=top.className.toUpperCase();
  const confidence=(top.probability*100).toFixed(1);
  resultDiv.innerText=`Káº¿t luáº­n: ${className}. Äá»™ tin cáº­y: ${confidence}%`;
  speak(`Káº¿t luáº­n: ${className}. Äá»™ tin cáº­y: ${confidence} pháº§n trÄƒm`);
  showDetails(className);
  detailsBtn.disabled=false;
}
function showDetails(className){
  const data=diseaseDetails[className];
  if(!data){detailsDiv.style.display='none'; return;}
  symptomsEl.innerText=data.symptoms;
  causesEl.innerText=data.causes;
  preventionEl.innerText=data.prevention;
  careEl.innerText=data.care;
  treatmentEl.innerText=data.treatment;
  detailsDiv.style.display='block';
  speak(`Chi tiáº¿t bá»‡nh ${className}. Biá»ƒu hiá»‡n: ${data.symptoms}. NguyÃªn nhÃ¢n: ${data.causes}. CÃ¡ch phÃ²ng: ${data.prevention}. ChÄƒm sÃ³c: ${data.care}. Äiá»u trá»‹: ${data.treatment}`);
}

// Event
startBtn.onclick = ()=>startCamera();
switchBtn.onclick = ()=>switchCamera();
captureBtn.onclick = ()=>captureImage();
analyzeBtn.onclick = ()=>analyzeImage();
detailsBtn.onclick = ()=>{ detailsDiv.style.display = detailsDiv.style.display==='block'?'none':'block'; };
</script>
</body>
</html>
