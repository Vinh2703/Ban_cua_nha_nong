<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåø AI Nh·∫≠n di·ªán b·ªánh tr√™n l√°</title>

  <!-- TensorFlow.js v√† Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #e8f5e9;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    h2 {
      color: #2e7d32;
      margin-bottom: 10px;
    }

    video, img {
      width: 90%;
      max-width: 360px;
      border-radius: 12px;
      border: 3px solid #66bb6a;
      margin-top: 10px;
    }

    button {
      margin: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background: #43a047;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover { background: #388e3c; }
    button:disabled { background: #ccc; color: #333; cursor: not-allowed; }

    #result {
      font-size: 18px;
      font-weight: bold;
      color: #1b5e20;
      margin-top: 10px;
    }

    #details {
      display: none;
      text-align: left;
      background: #f1f8e9;
      margin: 15px auto;
      padding: 10px;
      max-width: 700px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    #details table {
      width: 100%;
      border-collapse: collapse;
    }

    #details th {
      width: 30%;
      text-align: left;
      color: #2e7d32;
      padding: 6px;
      vertical-align: top;
    }

    #details td {
      padding: 6px;
      border-bottom: 1px solid #c5e1a5;
    }

    footer {
      margin-top: 15px;
      color: #388e3c;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h2>üåø AI Nh·∫≠n di·ªán b·ªánh tr√™n l√°</h2>
  <video id="webcam" autoplay playsinline></video>
  <img id="preview" style="display:none">

  <div>
    <button id="startBtn">üì∑ B·∫≠t camera</button>
    <button id="captureBtn" disabled>üì∏ Ch·ª•p ·∫£nh</button>
    <button id="analyzeBtn" disabled>ü§ñ Ph√¢n t√≠ch</button>
    <button id="detailsBtn" disabled>üìñ Xem chi ti·∫øt</button>
  </div>

  <div id="result">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

  <div id="details">
    <h3>Chi ti·∫øt b·ªánh:</h3>
    <div id="detailsTableContainer"></div>
  </div>

  <footer>¬© 2025 - ·ª®ng d·ª•ng AI Nh·∫≠n di·ªán b·ªánh l√° c√¢y | Teachable Machine + TensorFlow.js</footer>

  <script>
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
    let model, stream, lastClassName = null;

    const video = document.getElementById("webcam");
    const preview = document.getElementById("preview");
    const startBtn = document.getElementById("startBtn");
    const captureBtn = document.getElementById("captureBtn");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const detailsBtn = document.getElementById("detailsBtn");
    const resultDiv = document.getElementById("result");
    const detailsDiv = document.getElementById("details");
    const detailsContainer = document.getElementById("detailsTableContainer");

    const diseaseDetails = {
      "b·ªánh ƒë·ªëm n√¢u": {
        symptoms: "Xu·∫•t hi·ªán c√°c ƒë·ªëm n√¢u tr√≤n, sau lan r·ªông l√†m kh√¥ l√°.",
        causes: "N·∫•m Cercospora sp ph√°t tri·ªÉn trong ƒëi·ªÅu ki·ªán ·∫©m ∆∞·ªõt.",
        prevention: "Kh√¥ng t∆∞·ªõi qu√° ·∫©m, t·ªâa th∆∞a l√°, lu√¢n canh c√¢y tr·ªìng.",
        care: "Gi·ªØ v∆∞·ªùn th√¥ng tho√°ng, lo·∫°i b·ªè l√° b·ªánh.",
        treatment: "Phun thu·ªëc g·ªëc ƒë·ªìng ho·∫∑c Mancozeb theo h∆∞·ªõng d·∫´n."
      },
      "b·ªánh kh√¥ l√°": {
        symptoms: "L√° kh√¥ t·ª´ m√©p v√†o, chuy·ªÉn v√†ng, d·ªÖ r·ª•ng.",
        causes: "Do n·∫•m Alternaria sp g√¢y ra.",
        prevention: "Tr√°nh t∆∞·ªõi n∆∞·ªõc l√™n l√°, ki·ªÉm so√°t ƒë·ªô ·∫©m.",
        care: "Thu gom l√° b·ªánh ti√™u h·ªßy.",
        treatment: "Phun Daconil ho·∫∑c Score theo t·ª∑ l·ªá 1.5ml/l√≠t n∆∞·ªõc."
      },
      "kh·ªèe m·∫°nh": {
        symptoms: "L√° xanh ƒë·ªÅu, kh√¥ng c√≥ v·∫øt b·ªánh.",
        causes: "ƒêi·ªÅu ki·ªán sinh tr∆∞·ªüng t·ªët.",
        prevention: "Ti·∫øp t·ª•c chƒÉm s√≥c b√¨nh th∆∞·ªùng.",
        care: "Duy tr√¨ b√≥n ph√¢n v√† t∆∞·ªõi n∆∞·ªõc h·ª£p l√Ω.",
        treatment: "Kh√¥ng c·∫ßn x·ª≠ l√Ω th√™m."
      }
    };

    function normalizeName(name) {
      return name.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    async function loadModel() {
      resultDiv.textContent = "‚è≥ ƒêang t·∫£i m√¥ h√¨nh...";
      model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
      resultDiv.textContent = "‚úÖ M√¥ h√¨nh ƒë√£ s·∫µn s√†ng. Nh·∫•n b·∫≠t camera.";
    }

    loadModel();

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        startBtn.disabled = true;
        captureBtn.disabled = false;
        resultDiv.textContent = "üì∏ Camera ƒë√£ b·∫≠t, ch·ª•p ·∫£nh ƒë·ªÉ ph√¢n t√≠ch.";
      } catch (e) {
        alert("Kh√¥ng th·ªÉ b·∫≠t camera. H√£y c·∫•p quy·ªÅn truy c·∫≠p camera cho tr√¨nh duy·ªát.");
      }
    }

    function captureImage() {
      const c = document.createElement("canvas");
      c.width = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext("2d").drawImage(video, 0, 0);
      preview.src = c.toDataURL("image/jpeg");
      preview.style.display = "block";
      analyzeBtn.disabled = false;
      resultDiv.textContent = "üì∑ ·∫¢nh ƒë√£ ch·ª•p, nh·∫•n Ph√¢n t√≠ch.";
      detailsDiv.style.display = "none";
      detailsBtn.disabled = true;
    }

    async function analyzeImage() {
      if (!model || !preview.src) {
        alert("Ch∆∞a c√≥ ·∫£nh ho·∫∑c m√¥ h√¨nh ch∆∞a s·∫µn s√†ng.");
        return;
      }
      resultDiv.textContent = "üîç ƒêang ph√¢n t√≠ch...";
      await new Promise(r => preview.complete ? r() : preview.onload = r);

      const pred = await model.predict(preview);
      pred.sort((a, b) => b.probability - a.probability);
      const top = pred[0];
      const rawClass = top.className || "";
      const clsNorm = normalizeName(rawClass);
      const conf = (top.probability * 100).toFixed(1);

      resultDiv.textContent = `K·∫øt lu·∫≠n: ${rawClass} (${conf}%)`;
      lastClassName = clsNorm;

      const data = diseaseDetails[clsNorm];
      if (data) {
        renderDetails(rawClass, data);
        detailsBtn.disabled = false;
        detailsDiv.style.display = "block";
      } else {
        detailsContainer.innerHTML = "<p>Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt cho lo·∫°i b·ªánh n√†y.</p>";
        detailsDiv.style.display = "block";
        detailsBtn.disabled = true;
      }
    }

    function renderDetails(name, data) {
      let html = `<table>
        <tr><th>Chu·∫©n ƒëo√°n</th><td>${name}</td></tr>
        <tr><th>Tri·ªáu ch·ª©ng</th><td>${data.symptoms}</td></tr>
        <tr><th>Nguy√™n nh√¢n</th><td>${data.causes}</td></tr>
        <tr><th>Ph√≤ng ng·ª´a</th><td>${data.prevention}</td></tr>
        <tr><th>ChƒÉm s√≥c</th><td>${data.care}</td></tr>
        <tr><th>ƒêi·ªÅu tr·ªã</th><td>${data.treatment}</td></tr>
      </table>`;
      detailsContainer.innerHTML = html;
    }

    detailsBtn.addEventListener("click", () => {
      detailsDiv.style.display =
        detailsDiv.style.display === "block" ? "none" : "block";
    });

    startBtn.onclick = startCamera;
    captureBtn.onclick = captureImage;
    analyzeBtn.onclick = analyzeImage;
  </script>
</body>
</html>
