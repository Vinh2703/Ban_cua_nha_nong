<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Nh·∫≠n di·ªán b·ªánh tr√™n l√°</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      text-align: center;
      padding: 10px;
    }
    h1 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    video, img {
      width: 90%;
      max-width: 360px;
      border-radius: 10px;
      border: 2px solid #81c784;
      margin-top: 10px;
    }
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #66bb6a;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #1b5e20;
    }
    #details {
      background: #f1f8e9;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      display: none;
      text-align: left;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
    #details table {
      width: 100%;
      border-collapse: collapse;
    }
    #details th, #details td {
      padding: 6px 8px;
      border-bottom: 1px solid #dcedc8;
      vertical-align: top;
      text-align: left;
    }
    #details th {
      width: 28%;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <h1>üåø AI Nh·∫≠n di·ªán b·ªánh tr√™n l√°</h1>
  <video id="webcam" autoplay playsinline></video>
  <img id="preview" style="display:none;">
  <div>
    <button id="startBtn">üì∑ B·∫≠t camera</button>
    <button id="switchBtn" disabled>üîÑ ƒê·ªïi camera</button>
    <button id="stopBtn" disabled>üõë T·∫Øt camera</button>
    <button id="captureBtn" disabled>üì∏ Ch·ª•p ·∫£nh</button>
    <button id="analyzeBtn" disabled>ü§ñ Ph√¢n t√≠ch</button>
    <button id="detailsBtn" disabled>üìñ Xem chi ti·∫øt</button>
  </div>
  <div id="result">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

  <div id="details" aria-live="polite">
    <h3>Chi ti·∫øt b·ªánh:</h3>
    <div id="detailsTableContainer"></div>
  </div>

<script>
const MODEL_URL = "https://teachablemachine.withgoogle.com/models/YEWRSh9R8/";
let model = null, stream = null, currentDeviceId = null, videoDevices = [];
let lastClassName = null;

const diseaseDetails = {
  "B·ªÜNH ƒê·ªêM N√ÇU": {
    symptoms: "Xu·∫•t hi·ªán c√°c ƒë·ªëm n√¢u tr√≤n, sau lan r·ªông l√†m kh√¥ l√°.",
    causes: "N·∫•m Cercospora sp ph√°t tri·ªÉn trong ƒëi·ªÅu ki·ªán ·∫©m ∆∞·ªõt.",
    prevention: "Kh√¥ng t∆∞·ªõi qu√° ·∫©m, t·ªâa th∆∞a l√°, lu√¢n canh c√¢y tr·ªìng.",
    care: "Gi·ªØ v∆∞·ªùn th√¥ng tho√°ng, lo·∫°i b·ªè l√° b·ªánh.",
    treatment: "Phun thu·ªëc g·ªëc ƒë·ªìng ho·∫∑c Mancozeb theo h∆∞·ªõng d·∫´n."
  },
  "B·ªÜNH KH√î L√Å": {
    symptoms: "L√° kh√¥ t·ª´ m√©p v√†o, chuy·ªÉn v√†ng, d·ªÖ r·ª•ng.",
    causes: "Do n·∫•m Alternaria sp g√¢y ra.",
    prevention: "Tr√°nh t∆∞·ªõi n∆∞·ªõc l√™n l√°, ki·ªÉm so√°t ƒë·ªô ·∫©m.",
    care: "Thu gom l√° b·ªánh ti√™u h·ªßy.",
    treatment: "Phun Daconil ho·∫∑c Score theo t·ª∑ l·ªá 1.5ml/l√≠t n∆∞·ªõc."
  },
  "KH·ªéE M·∫†NH": {
    symptoms: "L√° xanh ƒë·ªÅu, kh√¥ng c√≥ v·∫øt b·ªánh.",
    causes: "ƒêi·ªÅu ki·ªán sinh tr∆∞·ªüng t·ªët.",
    prevention: "Ti·∫øp t·ª•c chƒÉm s√≥c b√¨nh th∆∞·ªùng.",
    care: "Duy tr√¨ b√≥n ph√¢n v√† t∆∞·ªõi n∆∞·ªõc h·ª£p l√Ω.",
    treatment: "Kh√¥ng c·∫ßn x·ª≠ l√Ω th√™m."
  }
};

const video = document.getElementById('webcam');
const preview = document.getElementById('preview');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');
const stopBtn = document.getElementById('stopBtn');
const captureBtn = document.getElementById('captureBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const detailsBtn = document.getElementById('detailsBtn');
const resultDiv = document.getElementById('result');
const detailsDiv = document.getElementById('details');
const detailsTableContainer = document.getElementById('detailsTableContainer');

function speak(text){
  if(!("speechSynthesis" in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'vi-VN';
  // cancel previous to avoid overlapping reads
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

/* N·∫°p m√¥ h√¨nh */
async function loadModel(){
  try {
    resultDiv.innerText = "‚è≥ ƒêang t·∫£i m√¥ h√¨nh...";
    await tf.ready();
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    resultDiv.innerText = "‚úÖ M√¥ h√¨nh s·∫µn s√†ng. Nh·∫•n B·∫≠t camera.";
    speak("M√¥ h√¨nh ƒë√£ s·∫µn s√†ng, nh·∫•n b·∫≠t camera ƒë·ªÉ b·∫Øt ƒë·∫ßu.");
  } catch (e) {
    resultDiv.innerText = "‚ùå L·ªói khi t·∫£i m√¥ h√¨nh.";
    console.error(e);
    speak("L·ªói khi t·∫£i m√¥ h√¨nh. Vui l√≤ng ki·ªÉm tra ƒë∆∞·ªùng d·∫´n ho·∫∑c m·∫°ng.");
  }
}
loadModel();

async function listVideoDevices(){
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoDevices = devices.filter(d => d.kind === 'videoinput');
  } catch (e) {
    videoDevices = [];
  }
}

async function startCamera(preferBack = true){
  try {
    await listVideoDevices();
    let constraints;
    if(videoDevices.length > 0){
      let back = videoDevices.find(d => /back|environment/i.test(d.label));
      if(preferBack && back){
        currentDeviceId = back.deviceId;
        constraints = { video: { deviceId: { exact: currentDeviceId } } };
      } else constraints = { video: { facingMode: "environment" } };
    } else constraints = { video: true };

    if(stream){ stopCamera(); }
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    captureBtn.disabled = false;
    stopBtn.disabled = false;
    switchBtn.disabled = videoDevices.length < 2;
    startBtn.disabled = true;
    resultDiv.innerText = "üì∏ Camera ƒë√£ b·∫≠t, b·∫°n c√≥ th·ªÉ ch·ª•p ·∫£nh.";
    speak("Camera ƒë√£ b·∫≠t, b·∫°n c√≥ th·ªÉ ch·ª•p ·∫£nh.");
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Kh√¥ng th·ªÉ b·∫≠t camera. H√£y m·ªü file n√†y b·∫±ng Chrome v√† cho ph√©p truy c·∫≠p camera.");
    speak("Kh√¥ng th·ªÉ b·∫≠t camera. H√£y m·ªü b·∫±ng tr√¨nh duy·ªát Chrome v√† c·∫•p quy·ªÅn camera.");
  }
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.srcObject = null;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  captureBtn.disabled = true;
  analyzeBtn.disabled = true;
  detailsBtn.disabled = true;
  resultDiv.innerText = "üõë Camera ƒë√£ t·∫Øt.";
  preview.style.display = 'none';
  preview.src = '';
  detailsDiv.style.display = 'none';
  lastClassName = null;
}

async function switchCamera(){
  if(videoDevices.length < 2) return;
  let idx = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
  currentDeviceId = videoDevices[(idx + 1) % videoDevices.length].deviceId;
  await startCamera(false);
}

function captureImage(){
  if(!video.videoWidth || !video.videoHeight){
    alert('‚ö†Ô∏è ·∫¢nh ch∆∞a s·∫µn s√†ng, th·ª≠ l·∫°i.');
    return;
  }
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  preview.src = canvas.toDataURL('image/jpeg');
  preview.style.display = 'block';
  analyzeBtn.disabled = false;
  resultDiv.innerText = "üì∑ ·∫¢nh ƒë√£ ch·ª•p, nh·∫•n Ph√¢n t√≠ch.";
  speak("·∫¢nh ƒë√£ ch·ª•p, nh·∫•n ph√¢n t√≠ch ƒë·ªÉ xem k·∫øt qu·∫£.");
  detailsDiv.style.display = 'none';
  lastClassName = null;
  detailsBtn.disabled = true;
}

async function analyzeImage(){
  if(!model){
    resultDiv.innerText = "‚ö†Ô∏è M√¥ h√¨nh ch∆∞a s·∫µn s√†ng.";
    speak("M√¥ h√¨nh ch∆∞a s·∫µn s√†ng, vui l√≤ng ƒë·ª£i.");
    return;
  }
  if(!preview.src){
    resultDiv.innerText = "‚ö†Ô∏è B·∫°n c·∫ßn ch·ª•p ·∫£nh tr∆∞·ªõc khi ph√¢n t√≠ch.";
    speak("B·∫°n c·∫ßn ch·ª•p ·∫£nh tr∆∞·ªõc khi ph√¢n t√≠ch.");
    return;
  }
  resultDiv.innerText = "üîç ƒêang ph√¢n t√≠ch...";
  speak("ƒêang ph√¢n t√≠ch ·∫£nh, vui l√≤ng ƒë·ª£i.");
  await new Promise(r => preview.complete ? r() : preview.onload = r);

  try {
    const prediction = await model.predict(preview);
    prediction.sort((a,b) => b.probability - a.probability);
    const top = prediction[0];
    const classNameRaw = top.className || "";
    const className = classNameRaw.toString().toUpperCase().trim();
    const confidence = (top.probability * 100).toFixed(1);
    resultDiv.innerText = `K·∫øt lu·∫≠n: ${className} (${confidence}%)`;
    speak(`K·∫øt lu·∫≠n ${className}, ƒë·ªô tin c·∫≠y ${confidence} ph·∫ßn trƒÉm.`);
    // l∆∞u nh√£n ƒë·ªÉ n√∫t xem chi ti·∫øt d√πng
    lastClassName = className;
    // ch·ªâ b·∫≠t n√∫t chi ti·∫øt n·∫øu c√≥ d·ªØ li·ªáu chi ti·∫øt s·∫µn
    detailsBtn.disabled = !(className in diseaseDetails);
    // ·∫®n chi ti·∫øt ban ƒë·∫ßu (ng∆∞·ªùi d√πng b·∫•m ƒë·ªÉ m·ªü)
    detailsDiv.style.display = 'none';
    // N·∫øu kh√¥ng c√≥ chi ti·∫øt, th√¥ng b√°o
    if(!(className in diseaseDetails)){
      detailsTableContainer.innerHTML = `<p>Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt cho k·∫øt lu·∫≠n "<b>${className}</b>".</p>`;
      speak("Xin l·ªói, kh√¥ng c√≥ th√¥ng tin chi ti·∫øt cho k·∫øt lu·∫≠n n√†y.");
    } else {
      // Chu·∫©n b·ªã n·ªôi dung chi ti·∫øt (kh√¥ng t·ª± ƒë·ªông hi·ªÉn th·ªã)
      renderDetails(className);
    }
  } catch (err) {
    console.error(err);
    resultDiv.innerText = "‚ùå L·ªói khi ph√¢n t√≠ch ·∫£nh.";
    speak("L·ªói khi ph√¢n t√≠ch ·∫£nh, vui l√≤ng th·ª≠ l·∫°i.");
  }
}

/* T·∫°o HTML b·∫£ng chi ti·∫øt */
function renderDetails(className){
  const data = diseaseDetails[className];
  if(!data){
    detailsTableContainer.innerHTML = `<p>Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt.</p>`;
    return;
  }
  const html = `
    <table>
      <tr><th>Chu·∫©n ƒëo√°n</th><td>${escapeHtml(className)}</td></tr>
      <tr><th>Tri·ªáu ch·ª©ng</th><td>${escapeHtml(data.symptoms)}</td></tr>
      <tr><th>Nguy√™n nh√¢n</th><td>${escapeHtml(data.causes)}</td></tr>
      <tr><th>Ph√≤ng ng·ª´a</th><td>${escapeHtml(data.prevention)}</td></tr>
      <tr><th>ChƒÉm s√≥c</th><td>${escapeHtml(data.care)}</td></tr>
      <tr><th>ƒêi·ªÅu tr·ªã</th><td>${escapeHtml(data.treatment)}</td></tr>
    </table>
  `;
  detailsTableContainer.innerHTML = html;
}

/* ƒê·ªçc to t·ª´ng m·ª•c chi ti·∫øt (tƒÉng tr·∫£i nghi·ªám) */
function speakDetails(className){
  const data = diseaseDetails[className];
  if(!data) return;
  // ƒë·ªçc t·ª´ng ph·∫ßn c√°ch nhau b·∫±ng kho·∫£ng d·ª´ng ng·∫Øn
  const full = `Chu·∫©n ƒëo√°n: ${className}. Tri·ªáu ch·ª©ng: ${data.symptoms}. Nguy√™n nh√¢n: ${data.causes}. C√°ch ph√≤ng ng·ª´a: ${data.prevention}. ChƒÉm s√≥c: ${data.care}. ƒêi·ªÅu tr·ªã: ${data.treatment}.`;
  speak(full);
}

/* N√∫t Xem chi ti·∫øt ‚Äî toggle hi·ªÉn th·ªã v√† ƒë·ªçc */
detailsBtn.onclick = () => {
  if(!lastClassName) return;
  if(detailsDiv.style.display === 'block'){
    detailsDiv.style.display = 'none';
  } else {
    // ƒë·∫£m b·∫£o n·ªôi dung ƒë√£ ƒë∆∞·ª£c render
    if(lastClassName in diseaseDetails && detailsTableContainer.innerHTML.trim() === ''){
      renderDetails(lastClassName);
    }
    detailsDiv.style.display = 'block';
    // ƒë·ªçc chi ti·∫øt
    speakDetails(lastClassName);
  }
};

/* Helpers */
function escapeHtml(text){
  if(!text) return '';
  return text.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* Event bindings n√∫t kh√°c */
startBtn.onclick = () => startCamera();
switchBtn.onclick = () => switchCamera();
stopBtn.onclick = () => stopCamera();
captureBtn.onclick = () => captureImage();
analyzeBtn.onclick = () => analyzeImage();

</script>
</body>
</html>
